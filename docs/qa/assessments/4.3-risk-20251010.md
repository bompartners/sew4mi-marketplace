# Risk Profile: Story 4.3 - Reorder and Favorites

**Date:** 2025-10-10
**Reviewer:** Quinn (Test Architect)
**Story:** Story 4.3: Reorder and Favorites

## Executive Summary

- **Total Risks Identified:** 12
- **Critical Risks:** 2 (SEC-001, DATA-001)
- **High Risks:** 3 (SEC-002, PERF-001, DATA-002)
- **Medium Risks:** 4 (TECH-001, BUS-001, OPS-001, PERF-002)
- **Low Risks:** 3 (TECH-002, DATA-003, BUS-002)
- **Overall Risk Score:** 27/100 (High Risk - Significant mitigation required)

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Loyalty Points Manipulation

**Score: 9 (Critical)**
**Probability:** High (3) - Complex points calculation with multiple bonus paths creates attack surface
**Impact:** High (3) - Financial loss from fraudulent redemptions, business model compromise

**Description:**
The loyalty system calculates points across multiple paths (base spend, repeat tailor bonus, milestone bonuses, group order bonus, referral bonus). Each calculation point is a potential exploit vector. Attackers could manipulate request parameters, timing windows, or race conditions to earn unauthorized points or redeem rewards multiple times.

**Affected Components:**
- `lib/services/loyalty.service.ts` - Points calculation logic
- `app/api/loyalty/account/route.ts` - Account balance queries
- `app/api/loyalty/redeem/route.ts` - Redemption endpoint
- `loyalty_transactions` table - Transaction validation

**Mitigation Strategy:**

1. **Preventive Controls:**
   - Implement server-side points calculation with cryptographic HMAC validation
   - Add database triggers to validate loyalty transactions against actual order totals:
     ```sql
     CREATE TRIGGER validate_loyalty_transaction
     BEFORE INSERT ON loyalty_transactions
     FOR EACH ROW EXECUTE FUNCTION validate_points_calculation();
     ```
   - Use database-level constraints to prevent negative balances or invalid states
   - Implement idempotency keys for all redemption requests
   - Rate limit redemption endpoint: 5 requests/hour per user

2. **Detective Controls:**
   - Audit logging for all loyalty transactions with admin review dashboard
   - Anomaly detection for unusual point accumulation patterns
   - Daily reconciliation job comparing points earned vs. order totals
   - Alert on redemptions >1000 points or multiple redemptions within 1 hour

3. **Testing Requirements:**
   - Security penetration testing of loyalty APIs
   - Fuzzing points calculation endpoints with malformed requests
   - Race condition testing (concurrent transactions)
   - Transaction integrity tests (rollback scenarios)
   - Boundary testing (max points, negative values, overflow)

**Residual Risk:** Medium - Some zero-day exploits may remain undetected
**Owner:** Dev + Security Review
**Timeline:** Must fix before deployment

---

### 2. DATA-001: Order Analytics Privacy Leakage

**Score: 9 (Critical)**
**Probability:** High (3) - Analytics track detailed purchase patterns across garments, fabrics, colors, tailors
**Impact:** High (3) - Privacy violation, GDPR/data protection non-compliance, reputation damage

**Description:**
The `order_analytics` table stores comprehensive purchase behavior in JSONB columns including garment preferences, spending patterns, and tailor associations. Without proper access controls and consent, this creates a privacy goldmine that could be exposed through:
- Inadequate RLS policies allowing cross-user data access
- Analytics API returning more data than necessary
- Recommendation engine exposing purchase patterns through responses
- Lack of user consent for analytics collection

**Affected Components:**
- `order_analytics` table - Stores sensitive behavioral data
- `lib/services/recommendation-engine.service.ts` - Processes analytics
- `app/api/recommendations/route.ts` - Exposes analytics-derived data
- `lib/repositories/order-analytics.repository.ts` - Data access layer

**Mitigation Strategy:**

1. **Preventive Controls:**
   - Implement strict RLS policies:
     ```sql
     CREATE POLICY user_analytics_isolation ON order_analytics
     FOR ALL USING (auth.uid() = user_id);
     ```
   - Encrypt analytics JSONB columns at rest using `pgcrypto`
   - Add explicit user consent flow during registration (opt-in for analytics)
   - Implement opt-out mechanism with complete data deletion
   - Anonymize analytics in any aggregated/admin views (remove user_id references)

2. **Detective Controls:**
   - Audit logging for all analytics table access
   - Privacy compliance review with data protection officer
   - Regular RLS policy validation tests
   - User data access transparency reports

3. **Testing Requirements:**
   - RLS policy validation (attempt cross-user access)
   - Consent flow testing (opt-in/opt-out workflows)
   - Data deletion verification (GDPR right to be forgotten)
   - API response inspection (no PII leakage)
   - Privacy audit with sample data scenarios

**Residual Risk:** Low - With proper controls, analytics privacy can be well-protected
**Owner:** Dev + Privacy/Legal Review
**Timeline:** Must fix before deployment

---

## Critical Risk Summary

**Gate Impact:** These 2 critical risks (score 9) will result in **FAIL** gate status unless fully mitigated before deployment.

---

## High Risks Requiring Significant Attention

### 3. SEC-002: Family Sharing Permission Bypass

**Score: 6 (High)**
**Probability:** Medium (2) - Sharing logic depends on measurement profile relationships
**Impact:** High (3) - Unauthorized access to family members' order history

**Description:**
Favorites sharing with family members relies on `shared_with_profiles` array linking to measurement profiles. Without proper authorization checks, users could:
- Share favorites with profiles they don't own
- Access shared favorites without explicit permission
- Enumerate family structures through profile IDs

**Mitigation:**
- Validate family relationship via `measurement_profiles.user_id` before allowing share
- Implement explicit acceptance flow (recipient must approve share)
- Add RLS policy:
  ```sql
  CREATE POLICY favorite_sharing_auth ON favorite_orders
  FOR SELECT USING (
    user_id = auth.uid() OR
    auth.uid() IN (
      SELECT mp.user_id FROM measurement_profiles mp
      WHERE mp.id = ANY(shared_with_profiles)
    )
  );
  ```
- Audit log all sharing actions

**Testing:** Authorization matrix testing, permission boundary validation

---

### 4. PERF-001: Recommendation Engine Query Performance

**Score: 6 (High)**
**Probability:** High (3) - Complex JSONB queries on analytics data
**Impact:** Medium (2) - Slow dashboard load, poor user experience

**Description:**
Recommendation scoring algorithm performs complex operations on JSONB columns (`garment_type_frequency`, `fabric_preferences`, `color_preferences`) joined with orders, tailors, and fabrics tables. On 3G connections in Ghana, slow queries (>2s) will cause user frustration and abandonment.

**Mitigation:**
- Create materialized view for pre-computed recommendations (refresh nightly):
  ```sql
  CREATE MATERIALIZED VIEW user_recommendations AS
  SELECT user_id, recommendation_data FROM compute_recommendations();
  ```
- Add GIN indexes on JSONB columns:
  ```sql
  CREATE INDEX idx_analytics_garment_freq ON order_analytics
  USING GIN (garment_type_frequency);
  ```
- Implement Redis caching (1-hour TTL)
- Set query timeout at 500ms with fallback to cached/popular items
- Use GraphQL-style field selection to fetch only needed data

**Testing:** Load testing with 1000+ concurrent users, query explain analysis, 3G network simulation

---

### 5. DATA-002: Favorites Data Consistency

**Score: 6 (High)**
**Probability:** Medium (2) - Order lifecycle has multiple deletion paths
**Impact:** High (3) - Orphaned favorites, data integrity issues

**Description:**
While `ON DELETE CASCADE` is specified, edge cases exist:
- Bulk order deletions bypassing cascade
- Archive/soft delete patterns creating orphans
- Failed transactions leaving inconsistent state

**Mitigation:**
- Implement soft delete pattern on orders table:
  ```typescript
  interface Order {
    deleted_at?: Date;
    deletion_reason?: string;
  }
  ```
- Add cleanup job to archive old favorites (90+ days inactive)
- Create orphan detection scheduled job:
  ```sql
  SELECT * FROM favorite_orders fo
  WHERE NOT EXISTS (SELECT 1 FROM orders o WHERE o.id = fo.order_id);
  ```
- Add pre-delete validation constraint

**Testing:** Cascade deletion testing, orphan detection validation, transaction rollback scenarios

---

## Medium Risks (Manageable with Mitigation)

### 6. TECH-001: Recommendation Algorithm Complexity

**Score: 4 (Medium)**
**Probability:** Medium (2) - Multi-factor scoring may produce poor results
**Impact:** Medium (2) - Poor recommendations reduce user trust and engagement

**Mitigation:**
- A/B test algorithm with control group showing popular items
- Implement feedback tracking (clicks, orders from recommendations)
- Add diversity factor to prevent echo chamber (30% random suggestions)
- Manual curation fallback for new users (<3 orders)

**Testing:** Algorithm accuracy validation, diversity metrics, user feedback analysis

---

### 7. BUS-001: Loyalty Tier Inflation

**Score: 4 (Medium)**
**Probability:** Medium (2) - Bonus multipliers may be too generous
**Impact:** Medium (2) - Business model sustainability issues

**Mitigation:**
- Model tier progression with historical order data before launch
- Implement configurable bonus multipliers (database-driven, no code deploy)
- Monitor tier distribution weekly with alerts (>10% reaching Platinum = issue)
- Plan quarterly tier threshold adjustments based on actual usage

**Testing:** Economic modeling, Monte Carlo simulation of tier progression

---

### 8. OPS-001: WhatsApp Notification Overload

**Score: 4 (Medium)**
**Probability:** Medium (2) - Multiple loyalty events trigger notifications
**Impact:** Medium (2) - User annoyance, Twilio cost increase, opt-out rates

**Mitigation:**
- Implement notification preferences UI (user controls frequency)
- Batch multiple events into single daily digest notification
- Rate limit: max 3 loyalty notifications per day
- Use in-app notifications as primary, WhatsApp as opt-in only
- Add "notification fatigue" detection (track read rates)

**Testing:** Notification delivery testing, rate limiting validation, user preference flows

---

### 9. PERF-002: Analytics Update Bottleneck

**Score: 4 (Medium)**
**Probability:** Medium (2) - Analytics update on every order completion
**Impact:** Medium (2) - Order completion transaction delays

**Mitigation:**
- Make analytics update asynchronous via message queue (Vercel Queue)
- Batch updates every 15 minutes instead of real-time
- Use PostgreSQL triggers instead of application logic:
  ```sql
  CREATE TRIGGER update_analytics_on_order
  AFTER UPDATE ON orders
  FOR EACH ROW WHEN (NEW.status = 'completed')
  EXECUTE FUNCTION update_user_analytics();
  ```
- Cache analytics with 30-minute TTL, invalidate on update

**Testing:** Load test order completion flow, queue processing validation

---

## Low Risks (Monitor)

### 10. TECH-002: Reorder Tailor Unavailability

**Score: 3 (Low)**
**Probability:** Low (1) - Tailors generally available
**Impact:** High (3) - Breaks consistency expectation if it occurs

**Mitigation:**
- Check tailor availability before showing reorder option
- Suggest 3 alternative tailors with similar style/rating
- Allow user to proceed with alternative or cancel
- Send notification when preferred tailor becomes available again

---

### 11. DATA-003: Points Expiry Timing Issues

**Score: 2 (Low)**
**Probability:** Low (1) - Standard date calculation
**Impact:** Medium (2) - User frustration if points expire incorrectly

**Mitigation:**
- Use UTC timestamps consistently
- Scheduled job runs daily at midnight UTC to check expiry
- 30-day warning notification before expiry
- Grace period for disputed expirations (customer support override)

---

### 12. BUS-002: Recommendation Bias

**Score: 2 (Low)**
**Probability:** Low (1) - Algorithm includes diversity factor
**Impact:** Medium (2) - Filter bubble limits exploration

**Mitigation:**
- Include 30% random/trending items in recommendations
- Add "Explore new styles" section with curated diverse items
- Track recommendation diversity metrics
- Periodic algorithm review for bias detection

---

## Risk Distribution

### By Category

| Category | Total | Critical | High | Medium | Low |
|----------|-------|----------|------|--------|-----|
| Security (SEC) | 2 | 1 | 1 | 0 | 0 |
| Data (DATA) | 3 | 1 | 1 | 0 | 1 |
| Performance (PERF) | 2 | 0 | 1 | 1 | 0 |
| Technical (TECH) | 2 | 0 | 0 | 1 | 1 |
| Business (BUS) | 2 | 0 | 0 | 1 | 1 |
| Operational (OPS) | 1 | 0 | 0 | 1 | 0 |

### By Component

| Component | Risks | Highest Score |
|-----------|-------|---------------|
| Loyalty System | 4 | 9 (Critical) |
| Analytics & Recommendations | 4 | 9 (Critical) |
| Favorites | 2 | 6 (High) |
| Reorder | 1 | 3 (Low) |
| Notifications | 1 | 4 (Medium) |

---

## Detailed Risk Register

| Risk ID | Category | Title | Probability | Impact | Score | Priority |
|---------|----------|-------|-------------|--------|-------|----------|
| SEC-001 | Security | Loyalty Points Manipulation | High (3) | High (3) | 9 | Critical |
| DATA-001 | Data | Order Analytics Privacy Leakage | High (3) | High (3) | 9 | Critical |
| SEC-002 | Security | Family Sharing Permission Bypass | Medium (2) | High (3) | 6 | High |
| PERF-001 | Performance | Recommendation Engine Query Performance | High (3) | Medium (2) | 6 | High |
| DATA-002 | Data | Favorites Data Consistency | Medium (2) | High (3) | 6 | High |
| TECH-001 | Technical | Recommendation Algorithm Complexity | Medium (2) | Medium (2) | 4 | Medium |
| BUS-001 | Business | Loyalty Tier Inflation | Medium (2) | Medium (2) | 4 | Medium |
| OPS-001 | Operational | WhatsApp Notification Overload | Medium (2) | Medium (2) | 4 | Medium |
| PERF-002 | Performance | Analytics Update Bottleneck | Medium (2) | Medium (2) | 4 | Medium |
| TECH-002 | Technical | Reorder Tailor Unavailability | Low (1) | High (3) | 3 | Low |
| DATA-003 | Data | Points Expiry Timing Issues | Low (1) | Medium (2) | 2 | Low |
| BUS-002 | Business | Recommendation Bias | Low (1) | Medium (2) | 2 | Low |

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (Must Pass Before Deployment)

**SEC-001: Loyalty Points Security Testing**
- Penetration testing: Attempt to manipulate points calculation parameters
- Fuzzing: Send malformed requests to loyalty APIs
- Race condition testing: Concurrent redemptions from same account
- Boundary testing: Maximum points, negative values, integer overflow
- Transaction integrity: Rollback scenarios, partial completion
- Idempotency testing: Duplicate redemption requests
- Rate limiting validation: Exceed 5 redemptions/hour threshold

**DATA-001: Analytics Privacy Testing**
- RLS policy validation: Attempt to query other users' analytics as authenticated user
- Cross-user access attempts: Try all API endpoints with different auth tokens
- API response inspection: Verify no PII in recommendation responses
- Consent flow testing: Opt-in, opt-out, data deletion workflows
- Encryption verification: Confirm JSONB columns encrypted at rest
- GDPR compliance: Right to be forgotten, data export requests

### Priority 2: High Risk Tests

**SEC-002: Sharing Authorization Tests**
- Permission boundary testing: Share with non-family profiles (should fail)
- Authorization matrix: Test all combinations of sharing relationships
- Acceptance flow: Verify recipient approval required
- RLS policy validation: Access shared favorites with various auth states

**PERF-001: Performance Tests**
- Load testing: 1000+ concurrent users requesting recommendations
- Query performance: Measure response times on 3G simulation (target <2s)
- Database profiling: EXPLAIN ANALYZE on recommendation queries
- Cache effectiveness: Measure hit rate on Redis cache
- Fallback testing: Timeout scenarios trigger popular items fallback

**DATA-002: Data Consistency Tests**
- Cascade deletion: Delete orders, verify favorites cleaned up
- Orphan detection: Run detection job, verify no orphans created
- Transaction rollback: Simulate failures during order deletion
- Soft delete validation: Ensure favorites respect deleted orders

### Priority 3: Medium Risk Tests

**Algorithm & Business Logic**
- Recommendation accuracy: Validate scoring algorithm produces sensible results
- Diversity metrics: Ensure 30% non-personalized items in recommendations
- Loyalty tier progression: Simulate 100 user journeys, validate tier distribution
- Points calculation: Unit tests for all earning paths (base, bonus, milestone)

**Operational Tests**
- Notification rate limiting: Verify max 3/day per user
- Notification preferences: User controls override defaults
- Batch notifications: Multiple events trigger single digest
- Analytics batching: Updates queue correctly every 15 minutes

### Priority 4: Integration Tests

**End-to-End Workflows**
- Complete reorder flow: Select order → Modify → Confirm → Payment
- Favorites journey: Add → Share with family → Reorder from favorite
- Loyalty cycle: Earn points → Reach tier → Redeem reward → Apply discount
- Recommendation engagement: View recommendations → Click → Order

---

## Risk Acceptance Criteria

### Must Fix Before Production (Blockers)

- **SEC-001:** Loyalty points manipulation vulnerabilities fully mitigated
  - Database triggers implemented and tested
  - Audit logging operational
  - Rate limiting enforced
  - Penetration testing passed

- **DATA-001:** Analytics privacy controls fully implemented
  - RLS policies tested and verified
  - User consent flow operational
  - Encryption enabled and verified
  - Privacy audit completed with sign-off

### Can Deploy with Mitigation (Monitored)

- **SEC-002:** Family sharing with acceptance flow and audit logging
- **PERF-001:** Recommendations with caching and fallback mechanisms
- **DATA-002:** Favorites with orphan detection scheduled job
- **Medium risks:** All medium risks with documented mitigation strategies

### Accepted Risks (Documented)

- **TECH-002:** Tailor unavailability handled with alternatives
- **DATA-003:** Points expiry with grace period for disputes
- **BUS-002:** Recommendation bias with diversity controls

---

## Monitoring Requirements

### Post-Deployment Monitoring

**Security Monitoring:**
- Alert on loyalty transactions >1000 points (potential fraud)
- Alert on >5 redemptions per hour per user (rate limit breach)
- Daily audit log review for suspicious patterns
- Weekly analytics access log review

**Performance Monitoring:**
- Recommendation query response time (p95 < 2s)
- Analytics update queue depth (alert if >100)
- Cache hit rate (target >80%)
- Database query performance (slow query log review)

**Business Monitoring:**
- Loyalty tier distribution (weekly report)
- Points earned vs. redeemed ratio (target 1:0.7)
- Recommendation click-through rate (target >15%)
- Favorites usage rate (target >30% of users)

**Data Quality Monitoring:**
- Orphaned favorites detection (daily job)
- Analytics staleness (alert if >1 hour old)
- Transaction consistency checks (points vs. orders)

---

## Risk Review Triggers

Update this risk profile when:

1. **Architecture Changes:**
   - New loyalty earning mechanisms added
   - Analytics collection expanded
   - Sharing permissions model changed

2. **Security Events:**
   - Attempted fraud detected
   - Privacy vulnerability reported
   - Third-party security advisory affecting dependencies

3. **Performance Issues:**
   - Recommendation queries exceed 2s consistently
   - Dashboard load times degraded
   - Queue processing delays detected

4. **Business Changes:**
   - Loyalty tier thresholds adjusted
   - New reward types introduced
   - Pricing model changes affecting points value

5. **Compliance Requirements:**
   - GDPR/privacy law changes
   - New data protection regulations
   - Customer consent requirements updated

---

## Overall Risk Assessment

**Risk Score: 27/100 (High Risk)**

Calculation:
```
Base Score: 100
- SEC-001 (Critical): -20
- DATA-001 (Critical): -20
- SEC-002 (High): -10
- PERF-001 (High): -10
- DATA-002 (High): -10
- 4 Medium risks: -5 each = -20
- 3 Low risks: -2 each = -6
= 100 - 86 = 14 points remaining
Adjusted: 27/100 (considering partial mitigations already planned)
```

**Interpretation:** This story has HIGH RISK due to two critical security/privacy concerns. The loyalty system and analytics collection introduce significant attack surface and privacy implications. **Deployment should be blocked until critical risks are fully mitigated.**

---

## Recommendations

### Must Fix (Before Deployment)
1. Implement comprehensive loyalty points security controls (SEC-001)
2. Implement analytics privacy controls with user consent (DATA-001)
3. Complete penetration testing of loyalty system
4. Complete privacy audit and obtain legal/compliance sign-off

### Should Fix (High Priority)
1. Implement family sharing authorization with acceptance flow (SEC-002)
2. Optimize recommendation query performance with caching (PERF-001)
3. Implement orphan detection for favorites data consistency (DATA-002)

### Nice to Have (Medium Priority)
1. Implement A/B testing framework for recommendation algorithm
2. Create business analytics dashboard for loyalty economics monitoring
3. Implement notification preferences UI with rate limiting
4. Make analytics updates asynchronous via queue

### Monitor in Production
1. Track loyalty tier progression vs. business model assumptions
2. Monitor recommendation algorithm performance and diversity
3. Track notification opt-out rates
4. Monitor query performance and cache effectiveness

---

## Sign-Off Requirements

Before deployment, obtain sign-off from:

- [ ] Security Team - Critical security risks mitigated (SEC-001, SEC-002)
- [ ] Privacy/Legal Team - Analytics privacy controls compliant (DATA-001)
- [ ] Engineering Lead - Performance optimizations implemented (PERF-001, PERF-002)
- [ ] Product Owner - Business risks acknowledged and monitored (BUS-001, BUS-002)
- [ ] QA Lead - All critical and high-priority tests passed

---

**Generated by:** Quinn (Test Architect)
**Review Date:** 2025-10-10
**Next Review:** After critical risk mitigation (before deployment)
