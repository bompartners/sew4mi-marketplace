# Story 4.4: Advanced Search and Filtering

## Status
**Draft**

## Story
**As a** customer,
**I want** powerful search tools,
**so that** I can find exactly what I need quickly.

## Acceptance Criteria
1. Search by occasion (wedding, work, church, graduation)
2. Filter by delivery timeframe and budget
3. Traditional vs contemporary style categories
4. Fabric type and color preferences
5. Size range specializations (plus size, children, tall)
6. Language spoken by tailor
7. Saved search alerts for new matching tailors

## Tasks / Subtasks

- [ ] Extend database schema for search attributes (AC: 1, 3, 4, 5, 6)
  - [ ] Add new columns to `tailor_profiles` table (occasions, style_categories, fabric_specialties, color_specialties, size_ranges, languages_spoken)
  - [ ] Create `saved_searches` table for user search alerts
  - [ ] Add GIN indexes on new JSONB/array fields for fast search
  - [ ] Create database function to check for new tailors matching saved searches
  - [ ] Write and apply migration file

- [ ] Update shared types and schemas (AC: 1-6)
  - [ ] Extend `TailorSearchFilters` interface with new filter fields
  - [ ] Update `TailorSearchItem` type with new attributes
  - [ ] Add new constants (occasions, styles, fabrics, languages, size ranges)
  - [ ] Update Zod validation schemas for search filters
  - [ ] Add `SavedSearch` and `SavedSearchInput` types

- [ ] Extend repository layer (AC: 1-7)
  - [ ] Update `TailorSearchRepository.searchTailors()` to support new filters
  - [ ] Add saved search CRUD methods (saveSearch, getSavedSearches, updateSavedSearch, deleteSavedSearch)
  - [ ] Implement `checkSavedSearchMatches()` for alert checking
  - [ ] Update query builder to handle occasion, style, fabric, color, size, language filters
  - [ ] Add unit tests for new repository methods

- [ ] Implement service layer extensions (AC: 1-7)
  - [ ] Update `TailorSearchService.searchTailors()` with new filter logic
  - [ ] Implement saved search management methods
  - [ ] Create notification logic for new matches
  - [ ] Add filter helper methods (filterByOccasion, filterByDeliveryTimeframe, filterByStyleCategory)
  - [ ] Add unit tests for service methods

- [ ] Create API endpoints (AC: 7)
  - [ ] Extend `GET /api/tailors/search` with new filter parameters
  - [ ] Create `POST /api/search/save` for saving searches with alerts
  - [ ] Create `GET /api/search/saved` for listing saved searches
  - [ ] Create `PUT /api/search/saved/:id` for updating saved searches
  - [ ] Create `DELETE /api/search/saved/:id` for deleting saved searches
  - [ ] Create `GET /api/search/saved/:id/check` for manual match checking
  - [ ] Add API route tests

- [ ] Build frontend filter components (AC: 1-6)
  - [ ] Create `SearchFilters.tsx` component with advanced filter UI
  - [ ] Add occasion filter dropdown with multi-select
  - [ ] Add delivery timeframe range selector
  - [ ] Add style category radio buttons (traditional/contemporary/both)
  - [ ] Add fabric and color preference multi-select
  - [ ] Add size range checkboxes
  - [ ] Add language filter multi-select
  - [ ] Integrate with existing `TailorSearchPage.tsx`

- [ ] Implement saved search UI (AC: 7)
  - [ ] Create `SavedSearches.tsx` component for managing saved searches
  - [ ] Create `SavedSearchAlert.tsx` for configuring alert settings
  - [ ] Add "Save Search" button to search results page
  - [ ] Create saved searches management page
  - [ ] Implement notification preference UI (daily/weekly/instant)
  - [ ] Add ability to name and edit saved searches

- [ ] Create custom hooks and state management (AC: 1-7)
  - [ ] Create `useAdvancedSearch` hook for filter state management
  - [ ] Create `useSavedSearches` hook for saved search operations
  - [ ] Extend search Zustand store with new filter state
  - [ ] Add React Query queries for saved searches

- [ ] Implement background job for search alerts (AC: 7)
  - [ ] Create cron job or scheduled function to check for new matches
  - [ ] Implement batch processing for all active saved searches
  - [ ] Send WhatsApp/email notifications for new matches
  - [ ] Track last notification timestamp to avoid duplicates

- [ ] Add comprehensive tests
  - [ ] Unit tests for filter logic in repository and service layers
  - [ ] Integration tests for complete search workflow with filters
  - [ ] E2E tests for saved search creation and management
  - [ ] Performance tests for search queries with multiple filters
  - [ ] Test search alert notification delivery

## Dev Notes

### Previous Story Insights
From Story 4.3, the following patterns and implementations are relevant:
- Repository pattern established with `TailorSearchRepository` [Source: apps/web/lib/repositories/tailor-search.repository.ts]
- Service layer pattern with `TailorSearchService` [Source: apps/web/lib/services/tailor-search.service.ts]
- React Query integration for data fetching with appropriate stale times
- Zustand store pattern for state management
- GIN indexes on JSONB fields improved query performance by 90-98% [Source: Story 4.3 performance optimizations]
- WhatsApp notification service successfully integrated for loyalty alerts

### Data Models
[Source: architecture/data-models.md]

**TailorProfile Model Extensions Needed:**
```typescript
interface TailorProfile {
  // Existing fields maintained...

  // New fields for Story 4.4:
  occasions?: string[];        // Array of supported occasions
  styleCategories?: string[];  // ['traditional', 'contemporary', 'fusion']
  fabricSpecialties?: string[]; // Array of fabric types
  colorSpecialties?: string[];  // Array of color expertise
  sizeRanges?: string[];        // ['petite', 'regular', 'plus-size', 'children']
  languagesSpoken?: string[];   // ['EN', 'TWI', 'GA', 'EWE', 'HAUSA']
  minDeliveryDays?: number;     // Minimum delivery timeframe
  maxDeliveryDays?: number;     // Maximum delivery timeframe
}
```

**SavedSearch Model (NEW):**
```typescript
interface SavedSearch {
  id: string;
  customerId: string;
  name: string;
  filters: TailorSearchFilters;
  alertEnabled: boolean;
  alertFrequency: 'daily' | 'weekly' | 'instant';
  createdAt: Date;
  lastNotifiedAt: Date | null;
}
```

### Database Schema
[Source: architecture/database-schema.md, existing migrations]

**Existing Search Infrastructure:**
- `tailor_profiles` table with GIN indexes on `business_name` and `specializations`
- `search_analytics` table for tracking search queries
- `customer_favorites` table for favorited tailors
- Full-text search using PostgreSQL tsvector
- `calculate_search_score()` function for relevance scoring

**New Tables Required:**
```sql
-- saved_searches table
CREATE TABLE saved_searches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  filters JSONB NOT NULL,
  alert_enabled BOOLEAN DEFAULT true,
  alert_frequency TEXT CHECK (alert_frequency IN ('daily', 'weekly', 'instant')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_notified_at TIMESTAMPTZ,
  CONSTRAINT unique_customer_search_name UNIQUE(customer_id, name)
);

CREATE INDEX idx_saved_searches_customer ON saved_searches(customer_id);
CREATE INDEX idx_saved_searches_alert ON saved_searches(alert_enabled, alert_frequency);
```

**Column Extensions for tailor_profiles:**
```sql
ALTER TABLE tailor_profiles
ADD COLUMN occasions TEXT[] DEFAULT '{}',
ADD COLUMN style_categories TEXT[] DEFAULT '{}',
ADD COLUMN fabric_specialties TEXT[] DEFAULT '{}',
ADD COLUMN color_specialties TEXT[] DEFAULT '{}',
ADD COLUMN size_ranges TEXT[] DEFAULT '{}',
ADD COLUMN languages_spoken TEXT[] DEFAULT '{}',
ADD COLUMN min_delivery_days INTEGER,
ADD COLUMN max_delivery_days INTEGER;

-- Add GIN indexes for array fields
CREATE INDEX idx_tailor_profiles_occasions ON tailor_profiles USING GIN(occasions);
CREATE INDEX idx_tailor_profiles_styles ON tailor_profiles USING GIN(style_categories);
CREATE INDEX idx_tailor_profiles_fabrics ON tailor_profiles USING GIN(fabric_specialties);
CREATE INDEX idx_tailor_profiles_sizes ON tailor_profiles USING GIN(size_ranges);
CREATE INDEX idx_tailor_profiles_languages ON tailor_profiles USING GIN(languages_spoken);
```

### API Specifications
[Source: architecture/api-specification.md, architecture/components.md#search-discovery-engine]

**Existing Endpoint to Extend:**
`GET /api/tailors/search` - Currently supports:
- query, city, region, specializations, minRating, minPrice, maxPrice
- sortBy: 'rating' | 'price' | 'responseTime' | 'distance'
- Pagination with cursor
- Rate limiting: 100 requests/minute
- Cache headers: 5-minute cache with stale-while-revalidate

**Extension Required:**
```typescript
interface ExtendedTailorSearchFilters extends TailorSearchFilters {
  // New filters for Story 4.4:
  occasions?: string[];
  deliveryTimeframeMin?: number;
  deliveryTimeframeMax?: number;
  styleCategories?: string[];
  fabricPreferences?: string[];
  colorPreferences?: string[];
  sizeRanges?: string[];
  languages?: string[];
}
```

**New Endpoints:**
- `POST /api/search/save` - Save search with optional alerts
- `GET /api/search/saved` - List user's saved searches
- `PUT /api/search/saved/:id` - Update saved search
- `DELETE /api/search/saved/:id` - Delete saved search
- `GET /api/search/saved/:id/check` - Check for new matches

### Component Architecture
[Source: architecture/frontend-architecture.md, architecture/components.md]

**Component Organization Pattern:**
```
components/features/tailors/
├── TailorSearchPage.tsx      // Existing - Main search page
├── TailorSearchResults.tsx   // Existing - Results display
├── SearchBar.tsx             // Existing - Search input
├── SearchFilters.tsx         // NEW - Advanced filter panel
├── SavedSearches.tsx         // NEW - Saved search management
├── SavedSearchAlert.tsx      // NEW - Alert configuration
└── FilterBadges.tsx          // NEW - Active filter display badges
```

**State Management Pattern:**
[Source: architecture/frontend-architecture.md#state-management-architecture]
```typescript
// Zustand store for search filters
interface SearchState {
  filters: ExtendedTailorSearchFilters;
  savedSearches: SavedSearch[];
  activeFilters: number; // Count of active filters
  actions: {
    updateFilters: (updates: Partial<ExtendedTailorSearchFilters>) => void;
    resetFilters: () => void;
    saveCurrentSearch: (name: string) => Promise<void>;
    loadSavedSearch: (id: string) => void;
    toggleFilter: (type: string, value: string) => void;
  };
}
```

### File Locations
[Source: architecture/unified-project-structure.md]

**Backend Files:**
- Migration: `sew4mi/supabase/migrations/[timestamp]_advanced_search_filters.sql`
- Types: `sew4mi/packages/shared/src/types/search.ts` (extend existing)
- Constants: `sew4mi/packages/shared/src/constants/search.ts` (extend existing)
- Repository: `sew4mi/apps/web/lib/repositories/tailor-search.repository.ts` (extend)
- Repository: `sew4mi/apps/web/lib/repositories/saved-search.repository.ts` (new)
- Service: `sew4mi/apps/web/lib/services/tailor-search.service.ts` (extend)
- Service: `sew4mi/apps/web/lib/services/saved-search.service.ts` (new)

**API Routes:**
- `sew4mi/apps/web/app/api/tailors/search/route.ts` (extend existing)
- `sew4mi/apps/web/app/api/search/save/route.ts` (new)
- `sew4mi/apps/web/app/api/search/saved/route.ts` (new)
- `sew4mi/apps/web/app/api/search/saved/[id]/route.ts` (new)
- `sew4mi/apps/web/app/api/search/saved/[id]/check/route.ts` (new)

**Frontend Files:**
- Components: `sew4mi/apps/web/components/features/tailors/SearchFilters.tsx` (new)
- Components: `sew4mi/apps/web/components/features/tailors/SavedSearches.tsx` (new)
- Components: `sew4mi/apps/web/components/features/tailors/SavedSearchAlert.tsx` (new)
- Components: `sew4mi/apps/web/components/features/tailors/FilterBadges.tsx` (new)
- Hooks: `sew4mi/apps/web/hooks/useAdvancedSearch.ts` (new)
- Hooks: `sew4mi/apps/web/hooks/useSavedSearches.ts` (new)
- Store: `sew4mi/apps/web/stores/search.store.ts` (extend existing)
- Page: `sew4mi/apps/web/app/(main)/saved-searches/page.tsx` (new)

### Ghana Market-Specific Constants
[Source: architecture/tech-stack.md - Ghana Market Optimization]

**Occasions:**
```typescript
export const GHANA_OCCASIONS = [
  'Wedding', 'Engagement', 'Funeral', 'Naming Ceremony',
  'Church Service', 'Corporate Event', 'Festival',
  'Birthday Party', 'Graduation', 'Casual Wear'
] as const;
```

**Style Categories:**
```typescript
export const STYLE_CATEGORIES = [
  { value: 'traditional', label: 'Traditional', icon: '🏛️' },
  { value: 'contemporary', label: 'Contemporary', icon: '✨' },
  { value: 'fusion', label: 'Fusion', icon: '🔄' }
] as const;
```

**Fabric Types:**
```typescript
export const GHANA_FABRICS = [
  'Kente', 'Ankara', 'Batik', 'Cotton', 'Silk',
  'Linen', 'Lace', 'Velvet', 'African Print',
  'Woodin', 'Vlisco', 'Dashiki', 'Adinkra'
] as const;
```

**Languages:**
```typescript
export const GHANA_LANGUAGES = [
  { code: 'EN', label: 'English' },
  { code: 'TWI', label: 'Twi' },
  { code: 'GA', label: 'Ga' },
  { code: 'EWE', label: 'Ewe' },
  { code: 'HAUSA', label: 'Hausa' },
  { code: 'FANTE', label: 'Fante' },
  { code: 'DAGBANI', label: 'Dagbani' },
  { code: 'NZEMA', label: 'Nzema' }
] as const;
```

**Size Ranges:**
```typescript
export const SIZE_RANGES = [
  { value: 'petite', label: 'Petite', description: 'XS-M sizes' },
  { value: 'regular', label: 'Regular', description: 'S-XL sizes' },
  { value: 'plus-size', label: 'Plus Size', description: '2XL+ sizes' },
  { value: 'children', label: 'Children', description: 'Ages 0-16' },
  { value: 'tall', label: 'Tall', description: 'Extended lengths' }
] as const;
```

### Performance Considerations
[Source: Story 4.3 performance optimizations]

**Database Performance:**
- Use GIN indexes on all array fields for fast containment queries
- Consider partial indexes for frequently filtered combinations
- Use materialized views for complex aggregations if needed
- Implement query result caching with Redis/Vercel KV (5-minute TTL)

**Frontend Performance:**
- Debounce search input (300ms as per existing SEARCH_CONFIG)
- Virtual scrolling for long result lists (>50 items)
- Lazy load filter options that aren't immediately visible
- Use React.memo for filter components to prevent unnecessary re-renders
- Implement optimistic UI for saved search operations

**Search Query Optimization:**
- Build queries dynamically - only add JOINs for active filters
- Use EXISTS subqueries instead of JOINs where possible
- Limit initial results to 20 (as per DEFAULT_LIMIT)
- Implement cursor-based pagination for infinite scroll

### Testing Requirements

**Testing Standards** [Source: architecture/testing-strategy.md]

**Test File Locations:**
- Unit tests: `sew4mi/apps/web/tests/unit/lib/services/tailor-search.service.test.ts` (extend)
- Unit tests: `sew4mi/apps/web/tests/unit/lib/services/saved-search.service.test.ts` (new)
- Unit tests: `sew4mi/apps/web/tests/unit/lib/repositories/tailor-search.repository.test.ts` (extend)
- Component tests: `sew4mi/apps/web/tests/unit/components/features/tailors/SearchFilters.test.tsx` (new)
- API tests: `sew4mi/apps/web/tests/unit/api/search/` (new directory)
- Integration: `sew4mi/apps/web/tests/integration/advanced-search-workflow.test.ts` (new)
- E2E: `tests/e2e/advanced-search.spec.ts` (new)

**Testing Frameworks:**
- Vitest for unit tests (60% statement coverage minimum)
- React Testing Library for component tests
- Playwright for E2E tests

**Specific Test Requirements:**
- Test each filter type independently and in combination
- Validate saved search CRUD operations
- Test alert notification scheduling and delivery
- Performance test queries with multiple filters active
- Test filter persistence across page refreshes
- Validate accessibility of filter components (keyboard navigation, screen readers)
- Test mobile responsiveness of filter UI
- Error handling for invalid filter combinations
- Test search result relevance with different filter combinations

### Security Considerations
[Source: architecture/backend-architecture.md#authentication-and-authorization]

- All search endpoints require authentication (except basic search)
- Saved searches require customer role
- RLS policies on saved_searches table restrict to owner
- Validate filter inputs to prevent SQL injection
- Rate limit search API to prevent abuse (100 req/min existing)
- Sanitize user-provided search names

### Mobile-First Design
[Source: architecture/tech-stack.md - Mobile-First Design]

- Filter panel as bottom sheet on mobile
- Touch-friendly checkboxes and multi-select (min 44px tap targets)
- Collapsible filter sections to save screen space
- Show active filter count badge when filters panel is closed
- Swipe gestures to clear all filters
- Optimize for 2G/3G with progressive enhancement

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-11 | 1.0 | Initial story creation for advanced search and filtering | Bob (Scrum Master) |