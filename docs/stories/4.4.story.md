# Story 4.4: Advanced Search and Filtering

## Status
**Approved**

## Story
**As a** customer,
**I want** powerful search tools,
**so that** I can find exactly what I need quickly.

## Acceptance Criteria
1. Search by occasion (wedding, work, church, graduation)
2. Filter by delivery timeframe and budget
3. Traditional vs contemporary style categories
4. Fabric type and color preferences
5. Size range specializations (plus size, children, tall)
6. Language spoken by tailor
7. Saved search alerts for new matching tailors

## Tasks / Subtasks

- [ ] Extend database schema for search attributes (AC: 1, 3, 4, 5, 6)
  - [ ] Add new columns to `tailor_profiles` table (occasions, style_categories, fabric_specialties, color_specialties, size_ranges, languages_spoken)
  - [ ] Create `saved_searches` table for user search alerts
  - [ ] Add GIN indexes on new JSONB/array fields for fast search
  - [ ] Create database function to check for new tailors matching saved searches
  - [ ] Write migration file: `supabase/migrations/YYYYMMDDHHMMSS_advanced_search_filters.sql` (use current timestamp)
  - [ ] Apply migration using Supabase CLI or SQL editor

- [ ] Update shared types and schemas (AC: 1-6)
  - [ ] Extend `TailorSearchFilters` interface with new filter fields
  - [ ] Update `TailorSearchItem` type with new attributes
  - [ ] Add new constants (occasions, styles, fabrics, languages, size ranges)
  - [ ] Update Zod validation schemas for search filters
  - [ ] Add `SavedSearch` and `SavedSearchInput` types

- [ ] Extend repository layer (AC: 1-7)
  - [ ] Update `TailorSearchRepository.searchTailors()` to support new filters
  - [ ] Add saved search CRUD methods (saveSearch, getSavedSearches, updateSavedSearch, deleteSavedSearch)
  - [ ] Implement `checkSavedSearchMatches()` for alert checking
  - [ ] Update query builder to handle occasion, style, fabric, color, size, language filters
  - [ ] Add unit tests for new repository methods

- [ ] Implement service layer extensions (AC: 1-7)
  - [ ] Update `TailorSearchService.searchTailors()` with new filter logic
  - [ ] Implement saved search management methods
  - [ ] Create notification logic for new matches
  - [ ] Add filter helper methods (filterByOccasion, filterByDeliveryTimeframe, filterByStyleCategory)
  - [ ] Add unit tests for service methods

- [ ] Create API endpoints (AC: 7)
  - [ ] Extend `GET /api/tailors/search` with new filter parameters
  - [ ] Create `POST /api/search/save` for saving searches with alerts
  - [ ] Create `GET /api/search/saved` for listing saved searches
  - [ ] Create `PUT /api/search/saved/:id` for updating saved searches
  - [ ] Create `DELETE /api/search/saved/:id` for deleting saved searches
  - [ ] Create `GET /api/search/saved/:id/check` for manual match checking
  - [ ] Add API route tests

- [ ] Build frontend filter components (AC: 1-6)
  - [ ] Create `SearchFilters.tsx` component with advanced filter UI
  - [ ] Add occasion filter dropdown with multi-select
  - [ ] Add delivery timeframe range selector
  - [ ] Add style category radio buttons (traditional/contemporary/both)
  - [ ] Add fabric and color preference multi-select
  - [ ] Add size range checkboxes
  - [ ] Add language filter multi-select
  - [ ] Integrate with existing `TailorSearchPage.tsx`

- [ ] Implement saved search UI (AC: 7)
  - [ ] Create `SavedSearches.tsx` component for managing saved searches
  - [ ] Create `SavedSearchAlert.tsx` for configuring alert settings
  - [ ] Add "Save Search" button to search results page
  - [ ] Create saved searches management page
  - [ ] Implement notification preference UI (daily/weekly/instant)
  - [ ] Add ability to name and edit saved searches

- [ ] Create custom hooks and state management (AC: 1-7)
  - [ ] Create `useAdvancedSearch` hook for filter state management
  - [ ] Create `useSavedSearches` hook for saved search operations
  - [ ] Extend search Zustand store with new filter state
  - [ ] Add React Query queries for saved searches

- [ ] Implement background job for search alerts (AC: 7)
  - [ ] Create cron job or scheduled function to check for new matches
  - [ ] Implement batch processing for all active saved searches
  - [ ] Send WhatsApp/email notifications for new matches
  - [ ] Track last notification timestamp to avoid duplicates

- [ ] Add comprehensive tests
  - [ ] Unit tests for filter logic in repository and service layers
  - [ ] Integration tests for complete search workflow with filters
  - [ ] E2E tests for saved search creation and management
  - [ ] Performance tests for search queries with multiple filters
  - [ ] Test search alert notification delivery

## Dev Notes

### Previous Story Insights
From Story 4.3, the following patterns and implementations are relevant:
- Repository pattern established with `TailorSearchRepository` [Source: apps/web/lib/repositories/tailor-search.repository.ts]
- Service layer pattern with `TailorSearchService` [Source: apps/web/lib/services/tailor-search.service.ts]
- React Query integration for data fetching with appropriate stale times
- Zustand store pattern for state management
- GIN indexes on JSONB fields improved query performance by 90-98% [Source: Story 4.3 performance optimizations]
- WhatsApp notification service successfully integrated for loyalty alerts

### Data Models
[Source: architecture/data-models.md]

**TailorProfile Model Extensions Needed:**
```typescript
interface TailorProfile {
  // Existing fields maintained...

  // New fields for Story 4.4:
  occasions?: string[];        // Array of supported occasions
  styleCategories?: string[];  // ['traditional', 'contemporary', 'fusion']
  fabricSpecialties?: string[]; // Array of fabric types
  colorSpecialties?: string[];  // Array of color expertise
  sizeRanges?: string[];        // ['petite', 'regular', 'plus-size', 'children']
  languagesSpoken?: string[];   // ['EN', 'TWI', 'GA', 'EWE', 'HAUSA']
  minDeliveryDays?: number;     // Minimum delivery timeframe
  maxDeliveryDays?: number;     // Maximum delivery timeframe
}
```

**SavedSearch Model (NEW):**
```typescript
interface SavedSearch {
  id: string;
  customerId: string;
  name: string;
  filters: TailorSearchFilters;
  alertEnabled: boolean;
  alertFrequency: 'daily' | 'weekly' | 'instant';
  createdAt: Date;
  lastNotifiedAt: Date | null;
}
```

### Database Schema
[Source: architecture/database-schema.md, existing migrations]

**Existing Search Infrastructure:**
- `tailor_profiles` table with GIN indexes on `business_name` and `specializations`
- `search_analytics` table for tracking search queries
- `customer_favorites` table for favorited tailors
- Full-text search using PostgreSQL tsvector
- `calculate_search_score()` function for relevance scoring

**New Tables Required:**
```sql
-- saved_searches table
CREATE TABLE saved_searches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  filters JSONB NOT NULL,
  alert_enabled BOOLEAN DEFAULT true,
  alert_frequency TEXT CHECK (alert_frequency IN ('daily', 'weekly', 'instant')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_notified_at TIMESTAMPTZ,
  CONSTRAINT unique_customer_search_name UNIQUE(customer_id, name)
);

CREATE INDEX idx_saved_searches_customer ON saved_searches(customer_id);
CREATE INDEX idx_saved_searches_alert ON saved_searches(alert_enabled, alert_frequency);
```

**Column Extensions for tailor_profiles:**
```sql
ALTER TABLE tailor_profiles
ADD COLUMN occasions TEXT[] DEFAULT '{}',
ADD COLUMN style_categories TEXT[] DEFAULT '{}',
ADD COLUMN fabric_specialties TEXT[] DEFAULT '{}',
ADD COLUMN color_specialties TEXT[] DEFAULT '{}',
ADD COLUMN size_ranges TEXT[] DEFAULT '{}',
ADD COLUMN languages_spoken TEXT[] DEFAULT '{}',
ADD COLUMN min_delivery_days INTEGER,
ADD COLUMN max_delivery_days INTEGER;

-- Add GIN indexes for array fields
CREATE INDEX idx_tailor_profiles_occasions ON tailor_profiles USING GIN(occasions);
CREATE INDEX idx_tailor_profiles_styles ON tailor_profiles USING GIN(style_categories);
CREATE INDEX idx_tailor_profiles_fabrics ON tailor_profiles USING GIN(fabric_specialties);
CREATE INDEX idx_tailor_profiles_sizes ON tailor_profiles USING GIN(size_ranges);
CREATE INDEX idx_tailor_profiles_languages ON tailor_profiles USING GIN(languages_spoken);
```

### API Specifications
[Source: architecture/api-specification.md, architecture/components.md#search-discovery-engine]

**Existing Endpoint to Extend:**
`GET /api/tailors/search` - Currently supports:
- query, city, region, specializations, minRating, minPrice, maxPrice
- sortBy: 'rating' | 'price' | 'responseTime' | 'distance'
- Pagination with cursor
- Rate limiting: 100 requests/minute
- Cache headers: 5-minute cache with stale-while-revalidate

**Extension Required:**
```typescript
interface ExtendedTailorSearchFilters extends TailorSearchFilters {
  // New filters for Story 4.4:
  occasions?: string[];
  deliveryTimeframeMin?: number;
  deliveryTimeframeMax?: number;
  styleCategories?: string[];
  fabricPreferences?: string[];
  colorPreferences?: string[];
  sizeRanges?: string[];
  languages?: string[];
}
```

**New Endpoints:**
- `POST /api/search/save` - Save search with optional alerts
  - Rate limit: 10 requests/minute (prevent spam)
  - Requires authentication
  - Validates search name and filters
- `GET /api/search/saved` - List user's saved searches
  - Rate limit: 100 requests/minute
  - Requires authentication
  - Returns paginated results
- `PUT /api/search/saved/:id` - Update saved search
  - Rate limit: 20 requests/minute
  - Requires authentication and ownership
  - Validates updates
- `DELETE /api/search/saved/:id` - Delete saved search
  - Rate limit: 20 requests/minute
  - Requires authentication and ownership
- `GET /api/search/saved/:id/check` - Check for new matches
  - Rate limit: 30 requests/minute (manual checking)
  - Requires authentication and ownership
  - Returns count of new matches since last notification

### Component Architecture
[Source: architecture/frontend-architecture.md, architecture/components.md]

**Component Organization Pattern:**
```
components/features/tailors/
â”œâ”€â”€ TailorSearchPage.tsx      // Existing - Main search page
â”œâ”€â”€ TailorSearchResults.tsx   // Existing - Results display
â”œâ”€â”€ SearchBar.tsx             // Existing - Search input
â”œâ”€â”€ SearchFilters.tsx         // NEW - Advanced filter panel
â”œâ”€â”€ SavedSearches.tsx         // NEW - Saved search management
â”œâ”€â”€ SavedSearchAlert.tsx      // NEW - Alert configuration
â””â”€â”€ FilterBadges.tsx          // NEW - Active filter display badges
```

**State Management Pattern:**
[Source: architecture/frontend-architecture.md#state-management-architecture]
```typescript
// Zustand store for search filters
interface SearchState {
  filters: ExtendedTailorSearchFilters;
  savedSearches: SavedSearch[];
  activeFilters: number; // Count of active filters
  actions: {
    updateFilters: (updates: Partial<ExtendedTailorSearchFilters>) => void;
    resetFilters: () => void;
    saveCurrentSearch: (name: string) => Promise<void>;
    loadSavedSearch: (id: string) => void;
    toggleFilter: (type: string, value: string) => void;
  };
}
```

### File Locations
[Source: architecture/unified-project-structure.md]

**Note:** All paths are relative to the monorepo root (`sew4mi/` directory)

**Backend Files:**
- Migration: `supabase/migrations/[timestamp]_advanced_search_filters.sql` (use format: `YYYYMMDDHHMMSS_advanced_search_filters.sql`)
- Types: `packages/shared/src/types/search.ts` (extend existing)
- Constants: `packages/shared/src/constants/search.ts` (extend existing - see "Constants File Organization" below)
- Repository: `apps/web/lib/repositories/tailor-search.repository.ts` âœ… EXISTS (extend)
- Repository: `apps/web/lib/repositories/saved-search.repository.ts` âŒ NEW (create)
- Service: `apps/web/lib/services/tailor-search.service.ts` âœ… EXISTS (extend)
- Service: `apps/web/lib/services/saved-search.service.ts` âŒ NEW (create)

**API Routes:**
- `apps/web/app/api/tailors/search/route.ts` âœ… EXISTS (extend)
- `apps/web/app/api/search/save/route.ts` âŒ NEW (create)
- `apps/web/app/api/search/saved/route.ts` âŒ NEW (create)
- `apps/web/app/api/search/saved/[id]/route.ts` âŒ NEW (create)
- `apps/web/app/api/search/saved/[id]/check/route.ts` âŒ NEW (create)

**Frontend Files:**
- Components: `apps/web/components/features/tailors/SearchFilters.tsx` âŒ NEW (create)
- Components: `apps/web/components/features/tailors/SavedSearches.tsx` âŒ NEW (create)
- Components: `apps/web/components/features/tailors/SavedSearchAlert.tsx` âŒ NEW (create)
- Components: `apps/web/components/features/tailors/FilterBadges.tsx` âŒ NEW (create)
- Hooks: `apps/web/hooks/useAdvancedSearch.ts` âŒ NEW (create)
- Hooks: `apps/web/hooks/useSavedSearches.ts` âŒ NEW (create)
- Store: `apps/web/stores/search.store.ts` (extend existing if exists, or create)
- Page: `apps/web/app/(main)/saved-searches/page.tsx` âŒ NEW (create)

### Constants File Organization

**Location:** `packages/shared/src/constants/search.ts` (extend existing file)

**Action:** Add the following Ghana-specific constants to the existing search constants file. If the file doesn't exist, create it with the structure below.

**Import Pattern:**
```typescript
import { GHANA_OCCASIONS, STYLE_CATEGORIES, GHANA_FABRICS, GHANA_LANGUAGES, SIZE_RANGES } from '@sew4mi/shared/constants';
```

### Ghana Market-Specific Constants
[Source: architecture/tech-stack.md - Ghana Market Optimization]

**Occasions:**
```typescript
export const GHANA_OCCASIONS = [
  'Wedding', 'Engagement', 'Funeral', 'Naming Ceremony',
  'Church Service', 'Corporate Event', 'Festival',
  'Birthday Party', 'Graduation', 'Casual Wear'
] as const;
```

**Style Categories:**
```typescript
export const STYLE_CATEGORIES = [
  { value: 'traditional', label: 'Traditional', icon: 'ðŸ›ï¸' },
  { value: 'contemporary', label: 'Contemporary', icon: 'âœ¨' },
  { value: 'fusion', label: 'Fusion', icon: 'ðŸ”„' }
] as const;
```

**Fabric Types:**
```typescript
export const GHANA_FABRICS = [
  'Kente', 'Ankara', 'Batik', 'Cotton', 'Silk',
  'Linen', 'Lace', 'Velvet', 'African Print',
  'Woodin', 'Vlisco', 'Dashiki', 'Adinkra'
] as const;
```

**Languages:**
```typescript
export const GHANA_LANGUAGES = [
  { code: 'EN', label: 'English' },
  { code: 'TWI', label: 'Twi' },
  { code: 'GA', label: 'Ga' },
  { code: 'EWE', label: 'Ewe' },
  { code: 'HAUSA', label: 'Hausa' },
  { code: 'FANTE', label: 'Fante' },
  { code: 'DAGBANI', label: 'Dagbani' },
  { code: 'NZEMA', label: 'Nzema' }
] as const;
```

**Size Ranges:**
```typescript
export const SIZE_RANGES = [
  { value: 'petite', label: 'Petite', description: 'XS-M sizes' },
  { value: 'regular', label: 'Regular', description: 'S-XL sizes' },
  { value: 'plus-size', label: 'Plus Size', description: '2XL+ sizes' },
  { value: 'children', label: 'Children', description: 'Ages 0-16' },
  { value: 'tall', label: 'Tall', description: 'Extended lengths' }
] as const;
```

### Background Job Implementation for Search Alerts
[Source: architecture/backend-architecture.md, Supabase Edge Functions documentation]

**Recommended Approach:** Supabase Edge Functions with pg_cron

**Implementation Details:**

1. **Scheduling Platform:** Use Supabase `pg_cron` extension for database-level scheduling
   - Location: `supabase/migrations/[timestamp]_setup_search_alerts_cron.sql`
   - Create scheduled job to run alert check function
   - No external dependencies required

2. **Alert Check Function:**
   - Location: `supabase/functions/check-search-alerts/index.ts`
   - Invoked by pg_cron on schedule
   - Queries all active saved searches with alerts enabled
   - Checks for new matching tailors since last notification
   - Batches notifications to avoid rate limits

3. **Execution Frequency:**
   - **Instant alerts:** Check every 15 minutes (balance between responsiveness and load)
   - **Daily alerts:** Run at 8:00 AM Ghana time (UTC+0)
   - **Weekly alerts:** Run Mondays at 8:00 AM Ghana time

4. **Alert Processing Logic:**
   ```sql
   -- Sample pg_cron job setup
   SELECT cron.schedule(
     'check-instant-alerts',
     '*/15 * * * *',  -- Every 15 minutes
     $$ SELECT check_instant_search_alerts() $$
   );

   SELECT cron.schedule(
     'check-daily-alerts',
     '0 8 * * *',  -- Daily at 8 AM
     $$ SELECT check_daily_search_alerts() $$
   );

   SELECT cron.schedule(
     'check-weekly-alerts',
     '0 8 * * 1',  -- Mondays at 8 AM
     $$ SELECT check_weekly_search_alerts() $$
   );
   ```

5. **Error Handling:**
   - Log all alert check executions to `alert_execution_log` table
   - Retry failed notifications with exponential backoff
   - Alert admins if alert system fails for >1 hour
   - Track notification delivery status

6. **Notification Delivery:**
   - Use existing `twilioService` for WhatsApp/SMS notifications
   - Use `emailService` for email notifications
   - Batch notifications to respect Twilio rate limits (100 req/min)
   - Track `last_notified_at` timestamp to prevent duplicates

7. **Performance Optimization:**
   - Process alerts in batches of 50 searches
   - Use database connection pooling
   - Cache tailor profiles to reduce database queries
   - Implement circuit breaker for notification service failures

### Performance Considerations
[Source: Story 4.3 performance optimizations]

**Database Performance:**
- Use GIN indexes on all array fields for fast containment queries
- Consider partial indexes for frequently filtered combinations
- Use materialized views for complex aggregations if needed
- Implement query result caching with Redis/Vercel KV (5-minute TTL)

**Frontend Performance:**
- Debounce search input (300ms as per existing SEARCH_CONFIG)
- Virtual scrolling for long result lists (>50 items)
- Lazy load filter options that aren't immediately visible
- Use React.memo for filter components to prevent unnecessary re-renders
- Implement optimistic UI for saved search operations

**Search Query Optimization:**
- Build queries dynamically - only add JOINs for active filters
- Use EXISTS subqueries instead of JOINs where possible
- Limit initial results to 20 (as per DEFAULT_LIMIT)
- Implement cursor-based pagination for infinite scroll

### Testing
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Unit tests: `apps/web/tests/unit/lib/services/tailor-search.service.test.ts` (extend)
- Unit tests: `apps/web/tests/unit/lib/services/saved-search.service.test.ts` (new)
- Unit tests: `apps/web/tests/unit/lib/repositories/tailor-search.repository.test.ts` (extend)
- Component tests: `apps/web/tests/unit/components/features/tailors/SearchFilters.test.tsx` (new)
- API tests: `apps/web/tests/unit/api/search/` (new directory)
- Integration: `apps/web/tests/integration/advanced-search-workflow.test.ts` (new)
- E2E: `tests/e2e/advanced-search.spec.ts` (new)

**Testing Standards:**
- **Coverage Requirements:** Minimum 60% statement coverage, 50% branch coverage
- **Unit Test Pattern:** Test each service and repository method independently with mocked dependencies
- **Component Test Pattern:** Use React Testing Library with user-centric queries (getByRole, getByLabelText)
- **Integration Test Pattern:** Test complete workflows from API endpoint through service to database
- **E2E Test Pattern:** Test user journeys across multiple pages with real browser interactions

**Testing Frameworks and Patterns:**
- **Vitest** for unit tests (apps/web/tests/unit/)
  - Use `describe` blocks for grouping related tests
  - Mock Supabase client and external services
  - Test synchronous and asynchronous logic
- **React Testing Library** for component tests
  - Test user interactions (click, type, select)
  - Verify accessible elements and ARIA attributes
  - Use `waitFor` for async state updates
- **Playwright** for E2E tests (tests/e2e/)
  - Run on Chrome, Firefox, Safari
  - Test on desktop and mobile viewports
  - Capture screenshots on failure

**Story-Specific Test Requirements:**
1. **Filter Functionality Tests:**
   - Test each filter type independently (occasion, delivery timeframe, style, fabric, color, size, language)
   - Test multiple filters applied simultaneously
   - Verify filter combinations produce correct result sets
   - Test filter reset and clear all functionality

2. **Saved Search Tests:**
   - Validate saved search CRUD operations (create, read, update, delete)
   - Test saved search naming and validation
   - Verify alert configuration (daily, weekly, instant)
   - Test duplicate search name prevention

3. **Search Alert Tests:**
   - Test alert notification scheduling logic
   - Verify notification delivery via WhatsApp/email
   - Test last notification timestamp tracking
   - Validate no duplicate notifications sent

4. **Performance Tests:**
   - Benchmark query performance with multiple active filters
   - Test with large result sets (100+ tailors)
   - Verify GIN index usage in query plans
   - Measure API response times under load

5. **Persistence and State Tests:**
   - Test filter persistence across page refreshes
   - Verify Zustand store state management
   - Test React Query cache invalidation
   - Validate URL parameter synchronization

6. **Accessibility Tests:**
   - Keyboard navigation through all filters
   - Screen reader announcements for filter changes
   - ARIA labels and roles verification
   - Focus management in modal/drawer components

7. **Mobile Responsiveness Tests:**
   - Test filter UI on mobile viewport (375px width)
   - Verify touch-friendly tap targets (min 44px)
   - Test bottom sheet filter panel behavior
   - Validate swipe gestures for clearing filters

8. **Error Handling Tests:**
   - Test invalid filter combinations
   - Verify API error responses
   - Test network failure scenarios
   - Validate user-friendly error messages

**Performance Benchmarks:**
- Database queries with filters: <200ms p95
- Frontend filter UI updates: <100ms
- API endpoint response: <500ms p95
- Page load with filters: <2s on 3G

### Security Considerations
[Source: architecture/backend-architecture.md#authentication-and-authorization]

- All search endpoints require authentication (except basic search)
- Saved searches require customer role
- RLS policies on saved_searches table restrict to owner
- Validate filter inputs to prevent SQL injection
- Rate limit search API to prevent abuse (100 req/min existing)
- Sanitize user-provided search names

### Mobile-First Design
[Source: architecture/tech-stack.md - Mobile-First Design]

- Filter panel as bottom sheet on mobile
- Touch-friendly checkboxes and multi-select (min 44px tap targets)
- Collapsible filter sections to save screen space
- Show active filter count badge when filters panel is closed
- Swipe gestures to clear all filters
- Optimize for 2G/3G with progressive enhancement

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-11 | 1.0 | Initial story creation for advanced search and filtering | Bob (Scrum Master) |
| 2025-10-12 | 1.1 | Story validation fixes: Added Testing subsection under Dev Notes, removed sew4mi/ path prefix, specified migration naming convention, defined background job implementation (Supabase pg_cron), clarified constants file location, added API rate limits, added file existence markers, included performance benchmarks | Sarah (Product Owner) |
| 2025-10-12 | 1.2 | Story approved for implementation | Sarah (Product Owner) |