# Story 0.1: External Service Account Setup & API Credential Management

## Status
Approved

## Story
**As a** platform administrator,  
**I want** to set up all required external service accounts and securely manage API credentials,  
**so that** developers have necessary access for third-party integrations without delays.

## Acceptance Criteria

**USER/ADMIN RESPONSIBILITIES (Manual Actions Required):**

1. WhatsApp Business Setup (Owner: Business Admin)
   - [ ] Create Meta Business Account at business.facebook.com
   - [ ] Create WhatsApp Business App in Meta Developer Console
   - [ ] Configure webhook URL: https://api.sew4mi.com/webhooks/whatsapp
   - [ ] Submit 5 initial message templates for approval:
     * Order confirmation template
     * Payment reminder template
     * Delivery notification template
     * Welcome message template
     * Dispute notification template
   - [ ] Document Phone Number ID: ________________
   - [ ] Document Business ID: ________________
   - [ ] Document Access Token: ________________
   - **Timeline: 2-3 days for Meta verification**
   - **Contact: Meta Business Support if issues**

2. Payment Provider Setup (Owner: Finance/Business Admin)
   - [ ] Register for Hubtel account at https://hubtel.com
   - [ ] Complete business KYC verification with:
     * Certificate of incorporation
     * Tax identification number
     * Bank account details
   - [ ] Obtain production credentials:
     * Client ID: ________________
     * Client Secret: ________________
     * Merchant Account ID: ________________
   - [ ] Request sandbox environment access
   - [ ] Configure callback URLs:
     * Success: https://api.sew4mi.com/webhooks/payment/success
     * Failure: https://api.sew4mi.com/webhooks/payment/failure
   - **Timeline: 5-7 business days for verification**
   - **Contact: Hubtel merchant support**

3. AI/ML Services Setup (Owner: Technical Lead)
   - [ ] Create OpenAI account at platform.openai.com
   - [ ] Add payment method (company card)
   - [ ] Set initial monthly limit: $100
   - [ ] Generate API key with Whisper API scope only
   - [ ] Document Organization ID: ________________
   - [ ] Document API Key: ________________
   - [ ] Test with sample audio file (Ghanaian accent)
   - **Timeline: Immediate**
   - **Budget: ~$0.006 per minute of audio**

4. Google Cloud Services (Owner: Technical Lead)
   - [ ] Create Google Cloud Project: "sew4mi-production"
   - [ ] Enable APIs:
     * [ ] Maps JavaScript API
     * [ ] Geocoding API
     * [ ] Distance Matrix API
     * [ ] Places API
   - [ ] Create API key with restrictions:
     * HTTP referrers: *.sew4mi.com, localhost:3000
   - [ ] Set quotas:
     * Geocoding: 1000/day
     * Distance Matrix: 1000/day
   - [ ] Enable billing (use $300 free credit)
   - [ ] Document API Key: ________________
   - **Timeline: Immediate**
   - **Monthly budget: $200 after free credit**

5. Email Service Configuration (Owner: DevOps/Technical Lead)
   - [ ] Create Resend account at resend.com
   - [ ] Add domain: sew4mi.com
   - [ ] Configure DNS records:
     * [ ] SPF record added
     * [ ] DKIM record added
     * [ ] DMARC record added
   - [ ] Verify domain ownership
   - [ ] Generate API key
   - [ ] Document API Key: ________________
   - [ ] Test deliverability score (aim for >90)
   - **Timeline: 24 hours for DNS propagation**
   - **Monthly budget: $20 for 10,000 emails**

**DEVELOPER RESPONSIBILITIES (Automated Setup):**

6. Credential Management Implementation
   - [ ] Create `.env.example` with all variables
   - [ ] Configure Vercel environment variables
   - [ ] Set up GitHub Secrets for CI/CD
   - [ ] Create validation script: `npm run validate:env`
   - [ ] Document rotation schedule (90 days)

7. Integration Verification
   - [ ] Create health check dashboard at /api/health
   - [ ] Write integration tests for each service
   - [ ] Verify webhook endpoints publicly accessible
   - [ ] Test complete payment flow in sandbox
   - [ ] Document fallback strategies

8. Security Measures
   - [ ] Enable secret scanning in GitHub
   - [ ] Configure rate limiting for API calls
   - [ ] Set up audit logging for API usage
   - [ ] Create incident response runbook
   - [ ] Test credential rotation procedure

## Tasks / Subtasks

### Manual Setup Tasks (Business/Admin Team)

- [ ] Complete WhatsApp Business Setup (AC: 1)
  - [ ] Create Meta Business Account
  - [ ] Set up WhatsApp Business App
  - [ ] Configure webhook URLs
  - [ ] Create and submit message templates
  - [ ] Document all IDs and tokens

- [ ] Complete Payment Provider Registration (AC: 2)
  - [ ] Register Hubtel business account
  - [ ] Submit KYC documents
  - [ ] Obtain API credentials
  - [ ] Configure webhook callbacks
  - [ ] Request sandbox access

- [ ] Set up AI/ML Services (AC: 3)
  - [ ] Create OpenAI account
  - [ ] Configure billing and limits
  - [ ] Generate Whisper API key
  - [ ] Test with sample audio

- [ ] Configure Google Cloud Platform (AC: 4)
  - [ ] Create GCP project
  - [ ] Enable required APIs
  - [ ] Set up API key restrictions
  - [ ] Configure quotas and billing

- [ ] Set up Email Service (AC: 5)
  - [ ] Create Resend account
  - [ ] Configure DNS records
  - [ ] Verify domain ownership
  - [ ] Generate API key

### Developer Implementation Tasks

- [ ] Implement Credential Management System (AC: 6)
  - [ ] Create comprehensive `.env.example` file with all required variables
  - [ ] Write script to validate environment variables (`scripts/validate-env.js`)
  - [ ] Document all environment variables in README
  - [ ] Set up credential rotation schedule documentation

- [ ] Configure Vercel Environment Variables (AC: 6)
  - [ ] Add all API keys to Vercel dashboard
  - [ ] Configure development, staging, and production environments
  - [ ] Set up environment-specific variables
  - [ ] Test deployment with environment variables

- [ ] Set up GitHub Secrets (AC: 6)
  - [ ] Add secrets for CI/CD workflows
  - [ ] Configure dependabot secrets
  - [ ] Set up environment-specific secrets
  - [ ] Test GitHub Actions with secrets

- [ ] Create Health Check Dashboard (AC: 7)
  - [ ] Implement `/api/health` endpoint
  - [ ] Add status checks for each external service
  - [ ] Create visual dashboard showing service status
  - [ ] Include response time metrics

- [ ] Write Integration Tests (AC: 7)
  - [ ] WhatsApp webhook verification test
  - [ ] Payment provider sandbox test
  - [ ] OpenAI Whisper API test
  - [ ] Google Maps geocoding test
  - [ ] Email delivery test

- [ ] Implement Security Measures (AC: 8)
  - [ ] Enable GitHub secret scanning
  - [ ] Configure rate limiting middleware
  - [ ] Set up API usage audit logging
  - [ ] Create incident response documentation
  - [ ] Implement credential rotation procedure

- [ ] Create Service Integration Modules (AC: 7)
  - [ ] WhatsApp service module with webhook handling
  - [ ] Payment service module with callback processing
  - [ ] Email service module with template support
  - [ ] Maps service module with caching
  - [ ] AI service module with error handling

## Dev Notes

### External Service Details
[Source: architecture/external-apis.md]

**WhatsApp Business Cloud API:**
- Base URL: `https://graph.facebook.com/v18.0/`
- Authentication: Bearer token with Facebook App credentials
- Rate Limits: 80 messages/second (customer-initiated), 1000 messages/second (business-initiated)
- Key Integration Points:
  - Webhook verification required
  - Media URLs expire after 5 minutes
  - Template messages must be pre-approved by Meta
- Webhook URL: `https://api.sew4mi.com/webhooks/whatsapp`

**MTN Mobile Money API (Primary Payment Provider):**
- Base URL: `https://api.mtn.com/collection/v2/`
- Authentication: OAuth 2.0 with API key and secret
- Rate Limits: 100 requests/second per API key
- Integration Notes:
  - Sandbox environment available for testing
  - Callbacks required for payment confirmation
  - Minimum transaction amount: GHS 0.01

**Hubtel Payment Gateway (Alternative):**
- Provides unified API for multiple mobile money providers
- Callback URLs:
  - Success: `https://api.sew4mi.com/webhooks/payment/success`
  - Failure: `https://api.sew4mi.com/webhooks/payment/failure`

**OpenAI Whisper API:**
- Base URL: `https://api.openai.com/v1/`
- Authentication: Bearer token with OpenAI API key
- Rate Limits: 50 requests/minute, 500,000 tokens/minute
- Supports: mp3, mp4, m4a formats up to 25MB
- Cost: ~$0.006 per minute of audio

**Google Maps API:**
- Base URL: `https://maps.googleapis.com/maps/api/`
- Authentication: API key with domain restrictions
- Rate Limits: 50 QPS for geocoding, 1000 elements/second for distance matrix
- Required APIs: Geocoding, Distance Matrix, Places, Maps JavaScript

**Resend Email API:**
- Base URL: `https://api.resend.com/`
- Authentication: Bearer token with API key
- Rate Limits: 100 emails/second
- Domain verification required

### Environment Variables Required
```env
# WhatsApp Business
WHATSAPP_PHONE_NUMBER_ID=
WHATSAPP_BUSINESS_ID=
WHATSAPP_ACCESS_TOKEN=
WHATSAPP_WEBHOOK_VERIFY_TOKEN=

# Payment Providers
HUBTEL_CLIENT_ID=
HUBTEL_CLIENT_SECRET=
HUBTEL_MERCHANT_ACCOUNT_ID=
MTN_MOMO_API_KEY=
MTN_MOMO_API_SECRET=
MTN_MOMO_SUBSCRIPTION_KEY=

# AI/ML Services
OPENAI_API_KEY=
OPENAI_ORGANIZATION_ID=

# Google Services
GOOGLE_MAPS_API_KEY=

# Email Service
RESEND_API_KEY=
RESEND_FROM_EMAIL=noreply@sew4mi.com

# Webhook URLs (for reference)
WEBHOOK_BASE_URL=https://api.sew4mi.com/webhooks
```

### API Authentication Patterns
[Source: architecture/api-specification.md]
- WhatsApp: Bearer token in Authorization header
- MTN MoMo: OAuth 2.0 flow with refresh tokens
- Hubtel: API key and secret in headers
- OpenAI: Bearer token in Authorization header
- Google Maps: API key as query parameter
- Resend: Bearer token in Authorization header

### Security Requirements
- All API keys must be stored in environment variables
- Never commit credentials to version control
- Enable GitHub secret scanning
- Implement rate limiting for all external API calls
- Log all API usage for audit purposes
- Rotate credentials every 90 days

### File Locations for Implementation
- Environment template: `.env.example`
- Environment validation: `scripts/validate-env.js`
- Health check endpoint: `apps/web/app/api/health/route.ts`
- Service modules: `apps/web/services/`
  - `apps/web/services/whatsapp.service.ts`
  - `apps/web/services/payment.service.ts`
  - `apps/web/services/email.service.ts`
  - `apps/web/services/maps.service.ts`
  - `apps/web/services/ai.service.ts`
- Integration tests: `apps/web/tests/integration/external-services/`
- GitHub workflows: `.github/workflows/`
- Security documentation: `docs/security/incident-response.md`

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Integration Test Requirements:**
- Test location: `apps/web/tests/integration/external-services/`
- Each external service must have integration tests
- Tests should use sandbox/test environments where available
- Mock external services for unit tests
- Real API calls only in integration tests

**Test Coverage:**
- WhatsApp webhook verification
- Payment provider sandbox transactions
- Email delivery verification
- Maps API geocoding accuracy
- Whisper API transcription

**Test Patterns:**
```typescript
// Example integration test structure
describe('External Service Integration', () => {
  it('verifies WhatsApp webhook signature', async () => {
    // Test webhook verification
  });
  
  it('processes payment in sandbox', async () => {
    // Test payment flow
  });
  
  it('sends test email', async () => {
    // Test email delivery
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-09 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]