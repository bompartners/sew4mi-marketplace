# Story 6.6: System Configuration and Pricing Management

## Status
**Draft**

## Story
**As a** platform administrator,  
**I want** to configure system-wide settings and manage garment pricing,  
**so that** the platform can adapt to market conditions without code deployments.

## Acceptance Criteria
1. Admin can view all garment types with current pricing in a table format
2. Admin can edit base prices and estimated delivery times for each garment type
3. Admin can add new garment types with full configuration
4. Admin can deactivate/reactivate garment types without deletion
5. Admin can configure fabric requirements (yards needed, supported types)
6. Admin can set measurement requirements for each garment type
7. Admin can configure platform-wide pricing multipliers (rush orders, fabric markup)
8. All pricing changes are logged with admin user, timestamp, and old/new values
9. Admin can preview pricing impact before applying changes
10. Changes take effect immediately without requiring code deployment

## Tasks / Subtasks

- [ ] Create database migration for garment types storage (AC: 1-6)
  - [ ] Create `system_garment_types` table with all required fields
  - [ ] Add fields: id, name, description, category, base_price, estimated_days, fabric_requirements (JSONB), measurements_required (array), image_url, is_active, display_order
  - [ ] Create `system_pricing_config` table for platform-wide settings
  - [ ] Add fields: id, setting_key, setting_value (JSONB), updated_by, updated_at
  - [ ] Create `pricing_audit_log` table for change tracking
  - [ ] Add fields: id, entity_type, entity_id, admin_id, old_value (JSONB), new_value (JSONB), change_description, created_at
  - [ ] Create indexes on system_garment_types (is_active, category, display_order)
  - [ ] Seed table with current hardcoded garment types from constants
  - [ ] Write migration file: `supabase/migrations/YYYYMMDDHHMMSS_system_configuration_pricing.sql`
  - [ ] Apply migration using Supabase CLI

- [ ] Update shared types and schemas (AC: 1-6)
  - [ ] Create `SystemGarmentType` interface extending current GarmentTypeOption
  - [ ] Create `SystemPricingConfig` interface for platform settings
  - [ ] Create `PricingAuditLog` interface for audit trail
  - [ ] Add `GarmentTypeInput` for create/update operations
  - [ ] Add Zod validation schemas: `systemGarmentTypeSchema`, `pricingConfigSchema`
  - [ ] Add constants for default values and constraints (min/max prices, delivery days)
  - [ ] Export all new types through shared package index

- [ ] Create repository layer for system configuration (AC: 1-10)
  - [ ] Create `system-config.repository.ts` with CRUD operations
  - [ ] Add `getAllGarmentTypes(includeInactive?: boolean)` method
  - [ ] Add `getGarmentTypeById(id: string)` method
  - [ ] Add `createGarmentType(data: GarmentTypeInput)` method
  - [ ] Add `updateGarmentType(id: string, data: Partial<GarmentTypeInput>)` method
  - [ ] Add `toggleGarmentTypeStatus(id: string, isActive: boolean)` method
  - [ ] Add `getPricingConfig()` method for platform settings
  - [ ] Add `updatePricingConfig(key: string, value: any)` method
  - [ ] Add database error handling and mapping
  - [ ] Write unit tests for repository methods

- [ ] Create audit logging service (AC: 8)
  - [ ] Create `pricing-audit.service.ts` for change tracking
  - [ ] Add `logPricingChange(entityType, entityId, adminId, oldValue, newValue, description)` method
  - [ ] Add `getAuditLog(entityType?, entityId?, startDate?, endDate?)` method
  - [ ] Add automatic audit logging on all pricing changes
  - [ ] Include admin user information in all logs
  - [ ] Add pagination support for audit log queries
  - [ ] Write unit tests for audit service

- [ ] Create API endpoints for garment type management (AC: 1-6, 8)
  - [ ] Create `GET /api/admin/garment-types` - List all garment types
    - [ ] Add query params: ?includeInactive=true, ?category=FORMAL
    - [ ] Return array of garment types with full details
    - [ ] Add admin role verification
  - [ ] Create `GET /api/admin/garment-types/[id]` - Get single garment type
    - [ ] Return full garment type details
    - [ ] Include audit log for this garment type
  - [ ] Create `POST /api/admin/garment-types` - Create new garment type
    - [ ] Validate input with Zod schema
    - [ ] Generate unique ID and slug
    - [ ] Create audit log entry
    - [ ] Return created garment type
  - [ ] Create `PUT /api/admin/garment-types/[id]` - Update garment type
    - [ ] Validate input with Zod schema
    - [ ] Log old and new values in audit trail
    - [ ] Return updated garment type
  - [ ] Create `PATCH /api/admin/garment-types/[id]/toggle` - Activate/deactivate
    - [ ] Toggle is_active status
    - [ ] Create audit log entry
    - [ ] Return updated status
  - [ ] Add admin authentication and authorization to all endpoints
  - [ ] Add request validation and error handling
  - [ ] Write integration tests for all endpoints

- [ ] Create API endpoints for pricing configuration (AC: 7, 10)
  - [ ] Create `GET /api/admin/pricing-config` - Get all pricing settings
    - [ ] Return urgency multiplier, fabric markup percentage, etc.
    - [ ] Include last updated timestamp and admin
  - [ ] Create `PUT /api/admin/pricing-config` - Update pricing settings
    - [ ] Validate numeric ranges (0-100% for percentages)
    - [ ] Create audit log entry
    - [ ] Return updated configuration
  - [ ] Add admin authentication and authorization
  - [ ] Write integration tests

- [ ] Create API endpoint for audit log access (AC: 8)
  - [ ] Create `GET /api/admin/audit-log/pricing` - Get pricing change history
    - [ ] Add filters: ?entityType=garment_type, ?entityId=uuid, ?startDate, ?endDate
    - [ ] Add pagination: ?page=1&limit=50
    - [ ] Return audit entries with admin details
  - [ ] Add admin authentication
  - [ ] Write integration tests

- [ ] Build admin garment types management page (AC: 1-6, 9)
  - [ ] Create `/admin/garment-types` page component
  - [ ] Build garment types table with columns:
    - [ ] Name, Category, Base Price, Est. Days, Status, Actions
    - [ ] Add sortable columns (price, days, name)
    - [ ] Add filtering by category and status
  - [ ] Add "Add New Garment Type" button with modal dialog
  - [ ] Build create/edit modal with form fields:
    - [ ] Name, Description, Category dropdown
    - [ ] Base Price (GHS), Estimated Days
    - [ ] Image URL upload/selection
    - [ ] Fabric Requirements section (yards, types, width)
    - [ ] Measurements Required multi-select
    - [ ] Active/Inactive toggle
  - [ ] Add inline edit buttons for each garment type
  - [ ] Add toggle active/inactive button with confirmation
  - [ ] Add pricing preview calculator showing impact
  - [ ] Display validation errors inline
  - [ ] Add success/error toast notifications
  - [ ] Implement loading states for all async operations

- [ ] Build pricing configuration page (AC: 7, 10)
  - [ ] Create `/admin/pricing-config` page component
  - [ ] Build pricing settings form with fields:
    - [ ] Urgency surcharge multiplier (percentage slider)
    - [ ] Fabric markup percentage (percentage slider)
    - [ ] Rush order base fee (GHS input)
    - [ ] Minimum order amount (GHS input)
  - [ ] Add preview section showing example calculations
  - [ ] Add "Save Changes" button with confirmation dialog
  - [ ] Display last updated info (admin name, timestamp)
  - [ ] Show unsaved changes warning
  - [ ] Add success/error notifications

- [ ] Build audit log viewer component (AC: 8)
  - [ ] Create `PricingAuditLog.tsx` component
  - [ ] Build table showing: Date, Admin, Entity, Change Description, Old/New Values
  - [ ] Add filters: Date range, Entity type, Admin user
  - [ ] Add pagination controls
  - [ ] Add "View Diff" modal showing detailed changes
  - [ ] Add export to CSV functionality
  - [ ] Style with color coding (price increase=red, decrease=green)

- [ ] Update garment types API to use database (AC: 10)
  - [ ] Modify `GET /api/orders/garment-types` to query database instead of constants
  - [ ] Add caching layer (Redis/Vercel KV) with 1-hour TTL
  - [ ] Invalidate cache on any garment type update
  - [ ] Maintain backward compatibility with existing frontend code
  - [ ] Add fallback to constants if database query fails
  - [ ] Update tests to use database-backed implementation

- [ ] Add navigation links to admin portal (AC: 1)
  - [ ] Add "Garment Types" link to admin navigation menu
  - [ ] Add "Pricing Configuration" link to admin navigation
  - [ ] Add "Audit Logs" link to admin navigation
  - [ ] Update `RoleBasedNavigation.tsx` for admin role
  - [ ] Add icons for new menu items (Settings, DollarSign, FileText)

- [ ] Implement comprehensive testing (AC: 1-10)
  - [ ] Write unit tests for repository layer (15+ tests)
  - [ ] Write unit tests for audit service (10+ tests)
  - [ ] Write integration tests for all API endpoints (20+ tests)
  - [ ] Write unit tests for React components (15+ tests)
  - [ ] Test admin authentication on all endpoints
  - [ ] Test validation for all input fields
  - [ ] Test audit logging on all changes
  - [ ] Test pricing preview calculations
  - [ ] Test cache invalidation on updates
  - [ ] E2E test for complete garment type lifecycle
  - [ ] E2E test for pricing configuration changes

## Dev Notes

### Previous Story Insights
From Story 1.4 (Role-Based Access Control):
- Admin role infrastructure is fully implemented
- Admin authentication middleware exists in `apps/web/middleware.ts`
- Admin dashboard framework exists at `/admin/dashboard`
- Admin navigation component: `RoleBasedNavigation.tsx`
- Admin permission checking utilities available

From Story 4.4 (Advanced Search and Filtering):
- Database migrations applied using Supabase CLI
- JSONB fields indexed with GIN for performance
- Repository pattern established for data access

From Story 4.5 (Customer Reviews and Ratings):
- Audit logging patterns established
- Admin moderation interfaces created
- Toast notification system available

### Current System State
**Hardcoded Pricing Location:**
- File: `packages/shared/src/constants/garment-types.ts`
- Contains 8 garment types with base prices (₵40 - ₵500)
- Includes fabric requirements, measurements, estimated days
- Used by: `/api/orders/calculate-pricing` and `/api/orders/garment-types`

**Pricing Calculation:**
- File: `apps/web/app/api/orders/calculate-pricing/route.ts`
- Formula: Base Price + Fabric Cost + Urgency Surcharge + Rush Fee
- Multipliers: 1.25 for express (25% surcharge), 0.30 for fabric (30% markup)

### Technology Stack Context
[Source: architecture/tech-stack.md]
- **Database:** PostgreSQL via Supabase with JSONB support for flexible schemas
- **Backend Framework:** Next.js API Routes (serverless functions)
- **Frontend Framework:** Next.js 14.2+ with App Router
- **UI Components:** Shadcn/ui + Tailwind CSS
- **State Management:** React Query for server state caching
- **Testing:** Vitest + Testing Library for unit/integration, Playwright for E2E

### Data Models Context
[Source: architecture/data-models.md]

**System Garment Type Model:**
```typescript
interface SystemGarmentType {
  id: string;
  name: string;
  description: string;
  category: GarmentCategory;
  basePrice: number;
  estimatedDays: number;
  fabricRequirements: {
    yardsNeeded: number;
    supportedTypes: FabricType[];
    preferredWidth: number;
  };
  measurementsRequired: string[];
  imageUrl: string | null;
  isActive: boolean;
  displayOrder: number;
  createdAt: string;
  updatedAt: string;
}
```

**Pricing Configuration Model:**
```typescript
interface SystemPricingConfig {
  id: string;
  urgencySurchargeMultiplier: number; // e.g., 1.25 for 25%
  fabricMarkupPercentage: number; // e.g., 0.30 for 30%
  rushOrderBaseFee: number; // GHS
  minimumOrderAmount: number; // GHS
  updatedBy: string; // Admin user ID
  updatedAt: string;
}
```

**Audit Log Model:**
```typescript
interface PricingAuditLog {
  id: string;
  entityType: 'garment_type' | 'pricing_config';
  entityId: string | null;
  adminId: string;
  adminName: string;
  oldValue: Record<string, any>;
  newValue: Record<string, any>;
  changeDescription: string;
  createdAt: string;
}
```

### File Locations
[Source: architecture/unified-project-structure.md]

**Note:** All paths are relative to the monorepo root (`sew4mi/` directory)

**Backend Files:**
- Migration: `supabase/migrations/YYYYMMDDHHMMSS_system_configuration_pricing.sql` (create with current timestamp)
- Types: `packages/shared/src/types/system-config.ts` ❌ NEW (create)
- Schemas: `packages/shared/src/schemas/system-config.schema.ts` ❌ NEW (create)
- Repository: `apps/web/lib/repositories/system-config.repository.ts` ❌ NEW (create)
- Service: `apps/web/lib/services/pricing-audit.service.ts` ❌ NEW (create)
- Constants Update: `packages/shared/src/constants/garment-types.ts` ✅ EXISTS (will be deprecated)

**API Routes:**
- `apps/web/app/api/admin/garment-types/route.ts` ❌ NEW (create)
- `apps/web/app/api/admin/garment-types/[id]/route.ts` ❌ NEW (create)
- `apps/web/app/api/admin/garment-types/[id]/toggle/route.ts` ❌ NEW (create)
- `apps/web/app/api/admin/pricing-config/route.ts` ❌ NEW (create)
- `apps/web/app/api/admin/audit-log/pricing/route.ts` ❌ NEW (create)
- `apps/web/app/api/orders/garment-types/route.ts` ✅ EXISTS (update to use database)

**Frontend Files:**
- Admin Page: `apps/web/app/admin/garment-types/page.tsx` ❌ NEW (create)
- Admin Page: `apps/web/app/admin/pricing-config/page.tsx` ❌ NEW (create)
- Components: `apps/web/components/features/admin/GarmentTypesTable.tsx` ❌ NEW (create)
- Components: `apps/web/components/features/admin/GarmentTypeForm.tsx` ❌ NEW (create)
- Components: `apps/web/components/features/admin/PricingConfigForm.tsx` ❌ NEW (create)
- Components: `apps/web/components/features/admin/PricingAuditLog.tsx` ❌ NEW (create)
- Components: `apps/web/components/features/admin/PricingPreview.tsx` ❌ NEW (create)
- Navigation: `apps/web/components/common/Navigation/RoleBasedNavigation.tsx` ✅ EXISTS (update)

**Test Files:**
- Repository Tests: `apps/web/tests/unit/lib/repositories/system-config.repository.test.ts` ❌ NEW
- Service Tests: `apps/web/tests/unit/lib/services/pricing-audit.service.test.ts` ❌ NEW
- API Tests: `apps/web/tests/integration/api/admin/garment-types.test.ts` ❌ NEW
- API Tests: `apps/web/tests/integration/api/admin/pricing-config.test.ts` ❌ NEW
- Component Tests: `apps/web/tests/unit/components/admin/garment-types.test.ts` ❌ NEW
- E2E Tests: `tests/e2e/admin/garment-types-management.spec.ts` ❌ NEW

### Coding Standards Context
[Source: architecture/coding-standards.md]

**Critical Implementation Rules:**
- **Type Sharing:** All types in `packages/shared/src/types` - never duplicate
- **API Calls:** Use repository pattern - never direct Supabase calls from API routes
- **Environment Variables:** Access through config objects only
- **Error Handling:** Standard error middleware for all API routes
- **State Updates:** React Query mutations for all server state changes
- **Database Access:** Repository pattern with proper error mapping

**Naming Conventions:**
- Components: `GarmentTypesTable.tsx`, `PricingConfigForm.tsx`
- API Routes: `/api/admin/garment-types`, `/api/admin/pricing-config`
- Database Tables: `system_garment_types`, `pricing_audit_log`
- Repository Methods: `getAllGarmentTypes()`, `updatePricingConfig()`

### Security Requirements
[Source: architecture/security-and-performance.md]

**Admin Authorization:**
- All endpoints must verify ADMIN role using existing middleware
- Audit log must capture admin user ID and timestamp
- No direct price manipulation without audit trail
- Preview calculations must not modify database

**Data Validation:**
- Zod schemas for all input validation
- Numeric bounds: prices (₵10-₵10,000), days (1-90), percentages (0-100%)
- Required fields enforced at database and application level
- Prevent SQL injection through parameterized queries (handled by Supabase)

### Performance Considerations

**Caching Strategy:**
- Cache garment types with 1-hour TTL (frequently accessed)
- Invalidate cache on any update operation
- Use Redis/Vercel KV for distributed caching
- Fallback to database query if cache miss

**Database Optimization:**
- Index on `is_active` and `category` for filtered queries
- Index on `display_order` for sorting
- GIN index on JSONB fields for fabric_requirements search
- Limit audit log queries with pagination (50 entries per page)

### Ghana-Specific Requirements

**Pricing Considerations:**
- All prices in Ghana Cedis (₵ GHS)
- Price ranges realistic for Ghana market (₵40 - ₵500 for garments)
- Consider seasonal pricing adjustments for events (weddings, funerals)
- Support for traditional garment types (Kente, Dashiki, Smock)

**Garment Categories:**
- Maintain Ghana cultural garment types (Traditional, Formal, Casual, Special Occasion)
- Support for local fabric types (Kente, Batik, etc.)
- Measurements in centimeters (Ghana standard)

### Migration Strategy

**Data Migration:**
1. Create new database tables
2. Seed with current 8 hardcoded garment types
3. Set default pricing configuration from constants
4. Update API to read from database (with fallback)
5. Test thoroughly before deprecating constants
6. Keep constants file for 1 release cycle as backup

**Backward Compatibility:**
- Maintain same API response structure
- Keep garment type IDs consistent (use slugs from constants)
- Ensure no breaking changes to order creation flow

### Environment Variables Required
- `NEXT_PUBLIC_SUPABASE_URL` - Already configured
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Already configured
- `SUPABASE_SERVICE_ROLE_KEY` - Already configured for admin operations
- Optional: `REDIS_URL` - For caching layer (future enhancement)

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test Coverage Requirements:**
- Repository layer: 90%+ coverage
- API endpoints: 100% coverage (all success/error paths)
- React components: 85%+ coverage
- E2E: Complete user workflows

**Test File Locations:**
- Unit tests: `apps/web/tests/unit/`
- Integration tests: `apps/web/tests/integration/`
- E2E tests: `tests/e2e/`

**Testing Frameworks:**
- Unit/Component Tests: Vitest with React Testing Library
- API Integration Tests: Vitest with Supabase client mocking
- E2E Tests: Playwright with test database

**Specific Testing Requirements:**

**Repository Layer Tests:**
- Test CRUD operations for garment types
- Test filtering (by category, active status)
- Test error handling (network failures, invalid data)
- Test pricing config updates
- Mock Supabase client responses

**API Endpoint Tests:**
- Test admin authentication (401 for non-admin)
- Test authorization (403 for non-admin roles)
- Test input validation (400 for invalid data)
- Test successful operations (200/201 responses)
- Test audit log creation on changes
- Test cache invalidation on updates

**Component Tests:**
- Test table rendering with mock data
- Test form validation and error display
- Test modal open/close behavior
- Test API integration with React Query
- Test loading and error states
- Test pricing preview calculations
- Mock API responses for all tests

**E2E Tests:**
- Test complete garment type creation workflow
- Test garment type edit and activation toggle
- Test pricing configuration update
- Test audit log viewing and filtering
- Test admin navigation
- Use test database with seeded data

**Test Patterns:**
```typescript
// Repository test pattern
describe('SystemConfigRepository', () => {
  it('should get all active garment types', async () => {
    const mockSupabase = createMockSupabaseClient({
      data: [{ id: '1', name: 'Shirt', is_active: true }],
      error: null
    });
    const repo = new SystemConfigRepository(mockSupabase);
    const result = await repo.getAllGarmentTypes(true);
    expect(result).toHaveLength(1);
    expect(result[0].isActive).toBe(true);
  });
});

// API test pattern
describe('GET /api/admin/garment-types', () => {
  it('should return 401 for non-authenticated users', async () => {
    const response = await request(app).get('/api/admin/garment-types');
    expect(response.status).toBe(401);
  });
  
  it('should return garment types for admin users', async () => {
    const response = await request(app)
      .get('/api/admin/garment-types')
      .set('Authorization', `Bearer ${adminToken}`);
    expect(response.status).toBe(200);
    expect(response.body.garmentTypes).toBeInstanceOf(Array);
  });
});

// Component test pattern
describe('GarmentTypesTable', () => {
  it('should render garment types in table', () => {
    const mockData = [{ id: '1', name: 'Shirt', basePrice: 40 }];
    render(<GarmentTypesTable data={mockData} />);
    expect(screen.getByText('Shirt')).toBeInTheDocument();
    expect(screen.getByText('₵40.00')).toBeInTheDocument();
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-18 | 1.0 | Initial story creation for system configuration and pricing management | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
*To be filled during implementation*

### Debug Log References
*To be filled during implementation*

### Completion Notes List
*To be filled during implementation*

### File List
*To be filled during implementation*

## QA Results
*To be filled after QA review*

