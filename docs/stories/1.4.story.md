# Story 1.4: Role-Based Access Control

## Status
Approved

## Story
**As a** platform administrator,  
**I want** different user roles with appropriate permissions,  
**so that** customers, expert tailors, and admins have access to relevant features.

## Acceptance Criteria
1. Three user roles defined: customer, expert_tailor, admin
2. Role assignment during registration (customers default, tailors apply)
3. Route protection based on user roles using middleware
4. Role-specific navigation menus and dashboards
5. Admin ability to modify user roles through Supabase dashboard
6. Audit log for role changes and permission updates

## Tasks / Subtasks

- [ ] Extend role system and permissions infrastructure (AC: 1)
  - [ ] Update user role types in shared types package
  - [ ] Create role-based permissions utility functions
  - [ ] Define role constants and permission matrices
  - [ ] Add role validation schemas to shared schemas

- [ ] Implement role assignment during registration (AC: 2)
  - [ ] Update registration form to include role selection
  - [ ] Create tailor application flow for expert_tailor role
  - [ ] Set default customer role for standard registration
  - [ ] Add role assignment logic to authentication service

- [ ] Build route protection middleware (AC: 3)
  - [ ] Enhance existing authentication middleware with role checking
  - [ ] Create role-based route guards for different user types
  - [ ] Implement unauthorized access handling
  - [ ] Add role validation to protected API endpoints

- [ ] Create role-specific navigation and dashboards (AC: 4)
  - [ ] Build customer navigation menu with customer-specific routes
  - [ ] Create tailor navigation with tailor dashboard and order management
  - [ ] Develop admin navigation with user management and system controls
  - [ ] Implement role-based dashboard components

- [ ] Develop admin role management interface (AC: 5)
  - [ ] Create admin dashboard for user role management
  - [ ] Build user search and role modification interface
  - [ ] Implement role change functionality with confirmation
  - [ ] Add bulk role assignment capabilities

- [ ] Implement audit logging for role changes (AC: 6)
  - [ ] Create audit log database table for role changes
  - [ ] Add logging service for permission and role updates
  - [ ] Build audit trail viewing interface for administrators
  - [ ] Implement audit log retention and archival policies

- [ ] Create comprehensive role-based testing (Testing requirement)
  - [ ] Write unit tests for role validation functions
  - [ ] Test route protection with different user roles
  - [ ] Create integration tests for role assignment flows
  - [ ] Test admin role management functionality
  - [ ] Add E2E tests for complete role-based workflows

## Dev Notes

### Previous Story Insights
From Story 1.3 (Authentication Flow Implementation):
- Supabase Auth is fully configured with user authentication system
- User database schema exists with role-based system (CUSTOMER, TAILOR, ADMIN)
- Authentication middleware framework is established in `sew4mi/apps/web/middleware.ts`
- User profile creation is automated on user registration
- Route groups are already structured for role-based access: `(auth)`, `(customer)`, `(tailor)`, `admin`
- Testing infrastructure is in place with unit and integration test frameworks

### Technology Stack Context
[Source: architecture/tech-stack.md]
- **Authentication:** Supabase Auth with role-based access control capabilities
- **Frontend Framework:** Next.js 14.2+ App Router with route groups for role separation
- **State Management:** Zustand + React Query for user state and role management
- **Backend Framework:** Next.js API Routes with serverless functions
- **Database:** PostgreSQL via Supabase with Row Level Security (RLS) for role-based data access
- **Testing:** Vitest + Testing Library for unit tests, Playwright for E2E tests

### Frontend Architecture Context
[Source: architecture/frontend-architecture.md]
**Route Organization for Role-Based Access:**
- Auth routes in `sew4mi/apps/web/app/(auth)/` for registration and login
- Customer routes in `sew4mi/apps/web/app/(customer)/` with customer role validation
- Tailor routes in `sew4mi/apps/web/app/(tailor)/` with tailor role verification
- Admin routes in `sew4mi/apps/web/app/admin/` with admin role requirements

**State Management for Roles:**
- User role state managed via Zustand store with role information
- Role-based navigation component visibility and access control
- React Query for server-side user role data caching and validation

**Component Architecture:**
- Role-specific navigation components in `sew4mi/apps/web/components/common/Navigation/`
- Role-based dashboard components in `sew4mi/apps/web/components/features/dashboards/`
- Admin components for user management in `sew4mi/apps/web/components/features/admin/`

### Backend Architecture Context
[Source: architecture/backend-architecture.md]
**Authentication Middleware Enhancement:**
- Existing auth middleware in `sew4mi/apps/web/middleware.ts` needs role checking functionality
- Role validation using `withAuth(['CUSTOMER', 'TAILOR', 'ADMIN'])` pattern
- User role retrieval from database during authentication verification
- Permission checking for API route access control

**API Route Protection:**
- Role-based endpoint protection using middleware wrapper functions
- Admin-only endpoints for user role management operations
- Role validation in all protected API routes
- Error handling for insufficient permissions (403 responses)

### Data Models Context
[Source: architecture/data-models.md]
**User Model with Role System:**
- User table with role field: `'CUSTOMER' | 'TAILOR' | 'ADMIN'`
- TailorProfile linked to users with role 'TAILOR'
- Role-based relationships and data access patterns
- User role validation and constraints at database level

**Role-Based Data Access:**
- Row Level Security (RLS) policies for role-based data filtering
- Customer access limited to own orders and profiles
- Tailor access to assigned orders and own business data
- Admin access to all system data with appropriate controls

### Project Structure Alignment
[Source: architecture/unified-project-structure.md]
**File Locations for New Code:**
- Role middleware enhancements: `sew4mi/apps/web/middleware.ts`
- Role utilities: `sew4mi/packages/shared/src/utils/roles.ts`
- Role constants: `sew4mi/packages/shared/src/constants/roles.ts`
- Role validation schemas: `sew4mi/packages/shared/src/schemas/role.schema.ts`
- Role components: `sew4mi/apps/web/components/features/roles/`
- Admin dashboard: `sew4mi/apps/web/app/admin/dashboard/page.tsx`
- Role management API: `sew4mi/apps/web/app/api/admin/users/role/route.ts`
- Audit logging service: `sew4mi/apps/web/lib/services/auditService.ts`

### Database Context
[Source: Previous Story 1.2 and 1.3]
**Existing Role Infrastructure:**
- User table with role field already configured
- Supabase Auth integration with user profile creation
- Row Level Security policies for basic data protection
- Database triggers for automated profile creation

**Required Database Extensions:**
- Audit log table for role changes and permission updates
- Admin activity tracking table for compliance
- Role change history with timestamps and admin references
- User role assignment validation constraints

### Security Requirements
[Source: architecture/security-and-performance.md]
**Role-Based Security Standards:**
- JWT token validation with role information extraction
- Role-based route protection at middleware level
- API endpoint access control with role verification
- Admin action logging for security compliance
- Secure role change validation with multi-step confirmation

### Coding Standards Context
[Source: architecture/coding-standards.md]
**Critical Role Implementation Rules:**
- Role constants defined in `packages/shared/src/constants/roles.ts`
- Role validation through Zod schemas in shared package
- No direct database access - use repository pattern for role operations
- Admin operations through dedicated service layer
- Error handling through standard middleware for unauthorized access

**Component and API Naming Standards:**
- Role components: `CustomerDashboard.tsx`, `TailorOrderManager.tsx`, `AdminUserManager.tsx`
- Role hooks: `useUserRole.ts`, `useRoleValidation.ts`, `useAdminActions.ts`
- API routes: `/api/admin/users/roles`, `/api/user/role-change`, `/api/audit/role-logs`

### Environment Variables Required
- `SUPABASE_SERVICE_ROLE_KEY` - Server-side role management operations
- Existing Supabase keys already configured from previous stories
- No additional external service configuration required

### Ghana-Specific Requirements
**Role Implementation Considerations:**
- Customer role supports Ghana phone number integration from Story 1.3
- Tailor role requires business registration validation for Ghana market
- Admin role supports local currency (GHS) and payment provider management
- Multi-language support consideration for role-based interfaces

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Role component tests: `sew4mi/apps/web/tests/unit/components/roles/`
- Role middleware tests: `sew4mi/apps/web/tests/unit/middleware/role.test.ts`
- Role API tests: `sew4mi/apps/web/tests/integration/api/admin/roles.test.ts`
- E2E role flow tests: `tests/e2e/role-based-access.spec.ts`

**Testing Frameworks:**
- Unit/Component Tests: Vitest with React Testing Library
- Middleware Testing: Vitest with Express/Next.js request mocking
- API Integration Tests: Vitest with Supabase client mocking
- E2E Tests: Playwright with multiple browser testing

**Specific Testing Requirements:**
- Test role assignment during registration for all user types
- Test route protection with unauthorized access attempts
- Test admin role management with different permission levels
- Test role-based navigation and component visibility
- Test audit logging for all role change operations
- Test middleware role validation with various user contexts
- Test API endpoint protection with insufficient permissions

**Test Patterns:**
- Mock Supabase Auth client for role-based unit tests
- Use test database with role-based RLS policies for integration tests
- Test role state management with Zustand store validation
- Mock admin users for testing administrative functionality
- Test role-based error handling and user feedback scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-17 | 1.0 | Initial story creation with comprehensive role-based access control requirements | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during implementation*

### Debug Log References
*To be populated during implementation*

### Completion Notes List
*To be populated during implementation*

### File List
*To be populated during implementation*

## QA Results
*This section will be populated by QA agent during review*